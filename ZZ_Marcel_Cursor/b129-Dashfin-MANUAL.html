<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Modelo - MANUAL COMENTADO</title>

  <!--
  ╔══════════════════════════════════════════════════════════════════════════════╗
  ║                                                                              ║
  ║   MANUAL DE IMPLEMENTAÇÃO - DASHBOARD SANKHYA                                ║
  ║   Versão Didática Comentada                                                  ║
  ║                                                                              ║
  ║   Este arquivo serve como MODELO BASE para criar novos dashboards.           ║
  ║   Contém instruções detalhadas, checklist e lições aprendidas.               ║
  ║                                                                              ║
  ╚══════════════════════════════════════════════════════════════════════════════╝

  ┌──────────────────────────────────────────────────────────────────────────────┐
  │ ÍNDICE DO MANUAL                                                             │
  ├──────────────────────────────────────────────────────────────────────────────┤
  │ 1. CHECKLIST PRÉ-IMPLEMENTAÇÃO                                               │
  │ 2. ESTRUTURA DO ARQUIVO (HTML/CSS/JS)                                        │
  │ 3. FASES DE IMPLEMENTAÇÃO                                                    │
  │ 4. ERROS COMUNS E COMO EVITAR                                                │
  │ 5. INTEGRAÇÃO COM SANKHYA JX                                                 │
  │ 6. VALIDAÇÃO FINAL                                                           │
  └──────────────────────────────────────────────────────────────────────────────┘

  ══════════════════════════════════════════════════════════════════════════════
  1. CHECKLIST PRÉ-IMPLEMENTAÇÃO
  ══════════════════════════════════════════════════════════════════════════════

  ANTES DE COMEÇAR, RESPONDA:
  
  □ Qual é a consulta SQL que será usada?
  □ Quais campos a consulta retorna? (listar TODOS os aliases)
  □ Quais KPIs serão exibidos? (totais, contagens, somas)
  □ Quais filtros rápidos são necessários? (status, vendedor, busca)
  □ Quais colunas aparecerão na tabela?
  □ Precisa de exportação CSV?
  □ Precisa de seleção múltipla (checkbox)?

  MAPEAMENTO SQL → JS (CRÍTICO):
  
  Para cada campo do SQL, definir:
  - Nome do alias SQL (ex.: NUNOTA, PARCEIRO)
  - Chave JS correspondente (ex.: row.NUNOTA, row.PARCEIRO)
  - Tipo de dado (número, texto, data, moeda)
  - Como será exibido na tabela
  - Se participa de algum KPI
  - Se participa de algum filtro

  ══════════════════════════════════════════════════════════════════════════════
  2. ESTRUTURA DO ARQUIVO
  ══════════════════════════════════════════════════════════════════════════════

  O arquivo é dividido em 3 blocos principais:

  BLOCO 1: HTML (estrutura visual)
  ├── KPIs (cards de resumo no topo)
  ├── Toolbar (filtros rápidos e botões)
  ├── Tabela (cabeçalho com data-column)
  ├── Dropdown de filtro por coluna
  ├── Paginação
  └── Containers auxiliares (loading, toast)

  BLOCO 2: CSS (estilos)
  ├── Variáveis CSS (:root)
  ├── Layout geral
  ├── Componentes (cards, badges, botões)
  └── Estados (.hidden, .selected, etc.)

  BLOCO 3: JS (lógica)
  ├── Configuração (CONFIG)
  ├── Query SQL
  ├── Estado global (dadosBrutos, dadosFiltrados, state)
  ├── Elementos do DOM
  ├── Funções auxiliares
  ├── Integração JX (carregar dados)
  ├── Processamento de dados
  ├── Renderização
  ├── Filtros e paginação
  └── Inicialização

  ══════════════════════════════════════════════════════════════════════════════
  3. FASES DE IMPLEMENTAÇÃO
  ══════════════════════════════════════════════════════════════════════════════

  FASE 1: PREPARAR A QUERY SQL
  ────────────────────────────
  □ Escrever a query SQL completa
  □ Testar no DBExplorer do Sankhya
  □ Listar TODOS os aliases retornados
  □ Anotar o tipo de cada campo
  
  FASE 2: AJUSTAR KPIs (HTML + JS)
  ────────────────────────────────
  □ Definir quantos KPIs serão exibidos
  □ No HTML: ajustar os cards (id, label, ícone)
  □ No JS: criar função calcularKPIs() usando os campos corretos
  □ Verificar se os IDs do HTML batem com os do JS
  
  FASE 3: AJUSTAR FILTROS RÁPIDOS (HTML + JS)
  ───────────────────────────────────────────
  □ Definir quais filtros rápidos existirão
  □ No HTML: criar <select> e <input> com IDs corretos
  □ No JS: capturar elementos pelo ID
  □ No JS: criar função aplicarFiltros() usando os campos corretos
  □ No JS: adicionar event listeners (change, input)
  
  FASE 4: AJUSTAR TABELA (HTML + JS)
  ──────────────────────────────────
  □ Definir quais colunas aparecerão
  □ No HTML: criar <th> com data-column correspondente
  □ No JS: ajustar getColumnValue() para cada data-column
  □ No JS: ajustar renderTable() para montar cada <td>
  □ Verificar se data-column casa com getColumnValue()
  
  FASE 5: INTEGRAR COM JX
  ───────────────────────
  □ Incluir <script src="jx.min.js"> ANTES do script principal
  □ Criar função getJXRef() (busca JX em window, parent, top)
  □ Criar função carregarDadosSankhya()
  □ Criar função normalizarDados() (maiúsc/minúsc)
  □ Remover dados mock
  □ Chamar carregarDadosSankhya() no init()
  
  FASE 6: VALIDAÇÃO
  ─────────────────
  □ Testar no ambiente Sankhya (não só local)
  □ Verificar console por erros
  □ Testar cada filtro
  □ Testar paginação
  □ Testar exportação CSV
  □ Verificar se KPIs atualizam com filtros

  ══════════════════════════════════════════════════════════════════════════════
  4. ERROS COMUNS E COMO EVITAR
  ══════════════════════════════════════════════════════════════════════════════

  ERRO 1: Loading overlay não some
  ────────────────────────────────
  CAUSA: CSS do #loadingOverlay (display: flex) tem especificidade maior que .hidden
  SOLUÇÃO: Usar .hidden { display: none !important; }
  
  ERRO 2: "JX não disponível"
  ───────────────────────────
  CAUSA: JX está em window.parent ou window.top (ambiente embed)
  SOLUÇÃO: Criar getJXRef() que busca em window, parent e top
  
  ERRO 3: Dados não aparecem mas não dá erro
  ──────────────────────────────────────────
  CAUSA: Chaves do retorno em maiúscula/minúscula diferente do esperado
  SOLUÇÃO: Criar normalizarDados() que padroniza as chaves
  
  ERRO 4: Filtro de coluna não funciona
  ─────────────────────────────────────
  CAUSA: data-column do <th> não casa com getColumnValue()
  SOLUÇÃO: Garantir que CADA data-column tem um case no switch
  
  ERRO 5: getElementById retorna null
  ───────────────────────────────────
  CAUSA: ID no HTML diferente do ID no JS
  SOLUÇÃO: Verificar se TODOS os IDs são idênticos (case-sensitive)
  
  ERRO 6: pageSize não reflete a seleção
  ──────────────────────────────────────
  CAUSA: state.pageSize diferente do <option selected> no HTML
  SOLUÇÃO: Sincronizar valor default do state com o HTML
  
  ERRO 7: Mock aparece em produção
  ────────────────────────────────
  CAUSA: Fallback para mock quando JX falha
  SOLUÇÃO: Em produção, NÃO usar mock - limpar tela e mostrar erro

  ══════════════════════════════════════════════════════════════════════════════
  5. INTEGRAÇÃO COM SANKHYA JX
  ══════════════════════════════════════════════════════════════════════════════

  BIBLIOTECA SANKHYAJX:
  <script src="https://cdn.jsdelivr.net/gh/wansleynery/SankhyaJX/jx.min.js"></script>

  PADRÃO DE BUSCA DO JX (ambiente embed):
  
  function getJXRef() {
    if (typeof JX !== 'undefined') return JX;
    if (window.parent && window.parent.JX) return window.parent.JX;
    if (window.top && window.top.JX) return window.top.JX;
    return undefined;
  }

  PADRÃO DE CONSULTA:
  
  function carregarDados() {
    var jxRef = getJXRef();
    if (!jxRef || typeof jxRef.consultar !== 'function') {
      // Exibir erro, limpar tela
      return;
    }
    
    loading(true);
    jxRef.consultar(SQL)
      .then(function(dados) {
        loading(false);
        dadosBrutos = normalizarDados(extrairDadosRetorno(dados));
        processarDados();
      })
      .catch(function(erro) {
        loading(false);
        toast('Erro: ' + erro.message, 'erro');
      });
  }

  FORMATOS DE RETORNO CONHECIDOS:
  - Array direto: dados
  - Objeto com result: dados.result
  - Objeto com data: dados.data
  - Objeto com rows: dados.rows

  ══════════════════════════════════════════════════════════════════════════════
  6. VALIDAÇÃO FINAL
  ══════════════════════════════════════════════════════════════════════════════

  CHECKLIST DE VALIDAÇÃO:
  
  □ Console sem erros
  □ Dados carregam do banco (não mock)
  □ Loading aparece e some corretamente
  □ KPIs mostram valores corretos
  □ Filtro de busca funciona
  □ Filtros de select funcionam
  □ Filtro por coluna funciona
  □ Paginação funciona
  □ Troca de pageSize funciona
  □ Checkbox select all funciona
  □ Exportar CSV funciona
  □ Botão Atualizar recarrega dados
  □ Atalhos de teclado funcionam (Alt+setas)

  ══════════════════════════════════════════════════════════════════════════════
  -->

  <style>
    /* ═══════════════════════════════════════════════════════════════════════
       CSS VARIABLES - DESIGN TOKENS
       ═══════════════════════════════════════════════════════════════════════
       
       TEORIA: Variáveis CSS permitem temas e consistência.
       Altere aqui para mudar cores em todo o dashboard.
    */
    :root {
      /* Cores base */
      --background: hsl(0 0% 100%);
      --foreground: hsl(222.2 84% 4.9%);
      --muted: hsl(210 40% 96.1%);
      --muted-foreground: hsl(215.4 16.3% 46.9%);
      --border: hsl(214.3 31.8% 91.4%);
      
      /* Cores de ação */
      --primary: hsl(221.2 83.2% 53.3%);
      --primary-foreground: hsl(210 40% 98%);
      
      /* Cores semânticas */
      --success: hsl(142 76% 36%);
      --success-bg: hsl(142 76% 94%);
      --warning: hsl(38 92% 50%);
      --warning-bg: hsl(38 92% 94%);
      --destructive: hsl(0 84% 60%);
      --destructive-bg: hsl(0 84% 94%);
      --info: hsl(221 83% 53%);
      --info-bg: hsl(221 83% 94%);
      
      /* Outros */
      --radius: 0.5rem;
      --font-sans: ui-sans-serif, system-ui, sans-serif;
      --card: hsl(0 0% 100%);
      --card-foreground: hsl(222.2 84% 4.9%);
    }

    /* Reset básico */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: var(--font-sans);
      background: var(--muted);
      color: var(--foreground);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ═══════════════════════════════════════════════════════════════════════
       REGRA CRÍTICA: .hidden com !important
       ═══════════════════════════════════════════════════════════════════════
       
       PROBLEMA ENCONTRADO: #loadingOverlay tinha display: flex, que tem
       maior especificidade que .hidden { display: none; }
       
       SOLUÇÃO: Usar !important garante que .hidden sempre funciona.
    */
    .hidden { display: none !important; }

    /* ═══════════════════════════════════════════════════════════════════════
       KPIs - CARDS DE RESUMO
       ═══════════════════════════════════════════════════════════════════════
       
       REGRA: Cada card precisa de um ID único no .status-card-value
       para que o JS possa atualizar o valor dinamicamente.
       
       Exemplo: <div class="status-card-value" id="kpiTotal">0</div>
    */
    .status-cards {
      display: grid;
      grid-template-columns: repeat(6, 1fr); /* Ajuste conforme qtd de KPIs */
      gap: 0.75rem;
      padding: 1rem;
      background: var(--card);
      border-bottom: 1px solid var(--border);
    }

    .status-card {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    /* Classes de cor para cada tipo de KPI */
    .status-card.total { background: var(--info-bg); border-color: hsl(221 83% 85%); }
    .status-card.receitas { background: var(--success-bg); border-color: hsl(142 76% 85%); }
    .status-card.despesas { background: var(--destructive-bg); border-color: hsl(0 84% 85%); }
    .status-card.aberto { background: var(--warning-bg); border-color: hsl(38 92% 85%); }
    .status-card.vencido { background: var(--destructive-bg); border-color: hsl(0 84% 85%); }
    .status-card.pago { background: var(--success-bg); border-color: hsl(142 76% 85%); }

    .status-card-icon {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: calc(var(--radius) - 2px);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .status-card.total .status-card-icon { background: var(--info); color: white; }
    .status-card.receitas .status-card-icon { background: var(--success); color: white; }
    .status-card.despesas .status-card-icon { background: var(--destructive); color: white; }
    .status-card.aberto .status-card-icon { background: var(--warning); color: white; }
    .status-card.vencido .status-card-icon { background: var(--destructive); color: white; }
    .status-card.pago .status-card-icon { background: var(--success); color: white; }

    .status-card-icon svg { width: 1.25rem; height: 1.25rem; }

    .status-card-content { min-width: 0; }

    .status-card-label {
      font-size: 0.625rem;
      font-weight: 500;
      color: var(--muted-foreground);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.125rem;
    }

    .status-card-value {
      font-size: 1rem;
      font-weight: 700;
      color: var(--foreground);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ═══════════════════════════════════════════════════════════════════════
       TOOLBAR - FILTROS RÁPIDOS
       ═══════════════════════════════════════════════════════════════════════
       
       REGRA: Cada input/select precisa de ID correspondente no JS.
       
       HTML                          JS
       id="searchInput"     →    var searchInput = document.getElementById('searchInput');
       id="filterStatus"    →    var filterStatus = document.getElementById('filterStatus');
       id="filterVendedor"  →    var filterVendedor = document.getElementById('filterVendedor');
       id="btnAtualizar"    →    document.getElementById('btnAtualizar').addEventListener(...)
       id="btnExportar"     →    document.getElementById('btnExportar').addEventListener(...)
    */
    .toolbar {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }

    .toolbar-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--foreground);
    }

    .toolbar-title svg { width: 1.25rem; height: 1.25rem; color: var(--primary); }

    .toolbar-spacer { flex: 1; }

    .search-input { position: relative; width: 280px; }

    .search-input input {
      width: 100%;
      height: 2rem;
      padding: 0 0.75rem 0 2.25rem;
      font-size: 0.75rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--background);
      color: var(--foreground);
    }

    .search-input input:focus {
      outline: 2px solid var(--primary);
      outline-offset: -1px;
    }

    .search-input svg {
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      width: 0.875rem;
      height: 0.875rem;
      color: var(--muted-foreground);
    }

    .filter-select {
      height: 2rem;
      padding: 0 0.75rem;
      font-size: 0.75rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--background);
      color: var(--foreground);
      cursor: pointer;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.375rem;
      height: 2rem;
      padding: 0 0.75rem;
      font-size: 0.75rem;
      font-weight: 500;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--background);
      color: var(--foreground);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .btn:hover:not(:disabled) { background: var(--muted); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn svg { width: 0.875rem; height: 0.875rem; }

    .btn-primary {
      background: var(--primary);
      border-color: var(--primary);
      color: var(--primary-foreground);
    }

    .btn-primary:hover { background: hsl(221.2 83.2% 48%); }

    /* ═══════════════════════════════════════════════════════════════════════
       TABELA - CABEÇALHO COM data-column
       ═══════════════════════════════════════════════════════════════════════
       
       REGRA CRÍTICA: O atributo data-column de cada <th> DEVE corresponder
       a um case no switch da função getColumnValue() no JS.
       
       Exemplo de correspondência:
       
       HTML: <th data-column="parceiro">
       JS:   case 'parceiro': return row.PARCEIRO || '';
       
       Se não houver correspondência, o filtro de coluna não funcionará.
    */
    .table-container {
      flex: 1;
      overflow: auto;
      background: var(--card);
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    .table th,
    .table td {
      padding: 0.625rem 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }

    .table th {
      background: var(--muted);
      font-weight: 600;
      color: var(--foreground);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .table-header-cell {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      cursor: pointer;
      user-select: none;
    }

    .table-header-cell:hover { color: var(--primary); }

    .filter-icon {
      width: 0.75rem;
      height: 0.75rem;
      color: var(--muted-foreground);
      opacity: 0;
      transition: opacity 0.15s;
    }

    .table th:hover .filter-icon { opacity: 1; }

    .table th { position: relative; }

    .resize-handle {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      cursor: col-resize;
      background: transparent;
    }

    .resize-handle:hover,
    .resize-handle.active { background: var(--primary); }

    .table tbody tr:nth-child(even) { background: hsl(210 40% 98%); }
    .table tbody tr:hover { background: hsl(210 40% 96%); }
    .table tbody tr.selected { background: hsl(221 83% 94%) !important; }

    /* ═══════════════════════════════════════════════════════════════════════
       COMPONENTES AUXILIARES
       ═══════════════════════════════════════════════════════════════════════
    */
    
    /* Checkbox */
    .checkbox {
      width: 1rem;
      height: 1rem;
      border: 1px solid var(--primary);
      border-radius: 0.25rem;
      appearance: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--background);
    }

    .checkbox:checked { background: var(--primary); }

    .checkbox:checked::after {
      content: '';
      width: 0.5rem;
      height: 0.5rem;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'/%3E%3C/svg%3E") center/contain no-repeat;
    }

    /* Badges de status */
    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      font-weight: 600;
      border-radius: 9999px;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }

    .badge-pago { background: var(--success-bg); color: var(--success); }
    .badge-pendente { background: var(--warning-bg); color: hsl(38 92% 40%); }
    .badge-vencido { background: var(--destructive-bg); color: var(--destructive); }

    /* Avatar do parceiro */
    .partner-cell {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .avatar {
      width: 1.875rem;
      height: 1.875rem;
      border-radius: 0.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.625rem;
      font-weight: 700;
      color: white;
      flex-shrink: 0;
    }

    .partner-name { font-weight: 500; color: var(--foreground); }

    /* Valores monetários */
    .value-positive { color: var(--success); font-weight: 600; }
    .value-negative { color: var(--destructive); font-weight: 600; }

    /* Seleção */
    .selection-count { font-size: 0.75rem; color: var(--muted-foreground); }

    /* ═══════════════════════════════════════════════════════════════════════
       DROPDOWN DE FILTRO POR COLUNA
       ═══════════════════════════════════════════════════════════════════════
    */
    .column-filter-dropdown {
      position: absolute;
      min-width: 220px;
      background: var(--background);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      z-index: 999;
      padding: 0.5rem;
      display: none;
    }

    .column-filter-dropdown.open { display: block; }

    .column-filter-actions,
    .column-filter-selectors { display: flex; gap: 0.5rem; }

    .column-filter-actions { margin-bottom: 0.5rem; }
    .column-filter-search { margin-bottom: 0.5rem; }

    .column-filter-search input {
      width: 100%;
      height: 1.75rem;
      padding: 0 0.5rem;
      font-size: 0.75rem;
      border: 1px solid var(--border);
      border-radius: calc(var(--radius) - 2px);
      background: var(--background);
      color: var(--foreground);
    }

    .column-filter-list {
      max-height: 220px;
      overflow: auto;
      margin-top: 0.5rem;
      padding-right: 0.25rem;
    }

    .column-filter-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.25rem 0.25rem;
      font-size: 0.75rem;
      color: var(--foreground);
    }

    .column-filter-item input { width: 0.875rem; height: 0.875rem; }

    .btn-small { height: 1.5rem; padding: 0 0.5rem; font-size: 0.6875rem; }

    /* ═══════════════════════════════════════════════════════════════════════
       PAGINAÇÃO
       ═══════════════════════════════════════════════════════════════════════
       
       REGRA: O valor default de state.pageSize no JS deve corresponder
       ao <option selected> no HTML.
       
       HTML: <option value="100" selected>100</option>
       JS:   var state = { pageSize: 100, ... }
    */
    .pagination-bar {
      flex-shrink: 0;
      border-top: 1px solid var(--border);
      background: hsl(210 40% 96.1% / 0.3);
      padding: 0.375rem 0.75rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.75rem;
    }

    .record-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--muted-foreground);
    }

    .record-info .highlight { font-weight: 500; color: var(--foreground); }

    .pagination-controls { display: flex; align-items: center; gap: 0.25rem; }

    .btn-icon {
      width: 1.75rem;
      height: 1.75rem;
      padding: 0;
      border: none;
      background: transparent;
      border-radius: calc(var(--radius) - 2px);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s ease;
    }

    .btn-icon:hover:not(:disabled) { background: hsl(210 40% 96.1%); }
    .btn-icon:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-icon svg { width: 1rem; height: 1rem; }

    .page-indicator {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0 0.5rem;
      margin: 0 0.25rem;
      background: var(--background);
      border-radius: calc(var(--radius) - 2px);
      border: 1px solid var(--border);
    }

    .page-indicator span { color: var(--muted-foreground); }
    .page-indicator .current-page { font-weight: 500; color: var(--foreground); }

    .page-input {
      width: 3.5rem;
      height: 1.5rem;
      font-size: 0.75rem;
      text-align: center;
      padding: 0.25rem;
      border: none;
      background: transparent;
      color: var(--foreground);
      font-family: inherit;
    }

    .page-input:focus { outline: none; }

    .page-size-container { display: flex; align-items: center; gap: 0.5rem; }

    .page-size-select {
      height: 1.75rem;
      width: 5rem;
      font-size: 0.75rem;
      padding: 0 0.5rem;
      border: 1px solid var(--border);
      border-radius: calc(var(--radius) - 2px);
      background: var(--background);
      color: var(--foreground);
      cursor: pointer;
      font-family: inherit;
    }

    .page-size-label { color: var(--muted-foreground); }

    /* ═══════════════════════════════════════════════════════════════════════
       LOADING OVERLAY E TOAST
       ═══════════════════════════════════════════════════════════════════════
       
       IMPORTANTE: Estes elementos devem existir no HTML para o JS funcionar.
       O loading usa a classe .hidden para aparecer/sumir.
    */
    #loadingOverlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    #loadingText {
      background: var(--background);
      border: 1px solid var(--border);
      padding: 0.75rem 1rem;
      border-radius: var(--radius);
      font-size: 0.875rem;
      color: var(--foreground);
    }

    #toastContainer {
      position: fixed;
      right: 1rem;
      top: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      z-index: 1100;
    }

    .toast {
      padding: 0.5rem 0.75rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--background);
      font-size: 0.75rem;
      color: var(--foreground);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
    }

    .toast-info { border-color: hsl(221 83% 85%); background: var(--info-bg); color: var(--info); }
    .toast-sucesso { border-color: hsl(142 76% 85%); background: var(--success-bg); color: var(--success); }
    .toast-erro { border-color: hsl(0 84% 85%); background: var(--destructive-bg); color: var(--destructive); }

    /* Responsive */
    @media (max-width: 1024px) {
      .status-cards { grid-template-columns: repeat(3, 1fr); }
    }

    @media (max-width: 640px) {
      .status-cards { grid-template-columns: repeat(2, 1fr); }
      .toolbar { flex-direction: column; align-items: stretch; }
      .search-input { width: 100%; }
    }
  </style>
</head>
<body>

  <!-- ═══════════════════════════════════════════════════════════════════════
       BLOCO HTML: KPIs
       ═══════════════════════════════════════════════════════════════════════
       
       INSTRUÇÕES:
       1. Ajuste a quantidade de cards conforme necessário
       2. Cada .status-card-value precisa de um ID único
       3. O JS atualizará esses IDs com document.getElementById('kpiXXX').textContent = valor;
       
       EXEMPLO DE MAPEAMENTO:
       ID HTML: kpiTotal     →  JS: document.getElementById('kpiTotal').textContent = total;
       ID HTML: kpiValor     →  JS: document.getElementById('kpiValor').textContent = 'R$ ' + valor;
  -->
  <div class="status-cards">
    <!-- KPI 1: Total de registros -->
    <div class="status-card total">
      <div class="status-card-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
          <path d="M15 2H9a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1Z"/>
        </svg>
      </div>
      <div class="status-card-content">
        <div class="status-card-label">Total</div>
        <!-- ID OBRIGATÓRIO para o JS atualizar -->
        <div class="status-card-value" id="kpiTotal">0</div>
      </div>
    </div>

    <!-- KPI 2: Valor total -->
    <div class="status-card receitas">
      <div class="status-card-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
        </svg>
      </div>
      <div class="status-card-content">
        <div class="status-card-label">Valor Total</div>
        <div class="status-card-value" id="kpiValor">R$ 0,00</div>
      </div>
    </div>

    <!-- Adicione mais KPIs conforme necessário -->
    <!-- Copie o bloco acima e ajuste: classe, ícone, label, ID -->
  </div>

  <!-- ═══════════════════════════════════════════════════════════════════════
       BLOCO HTML: TOOLBAR (Filtros Rápidos)
       ═══════════════════════════════════════════════════════════════════════
       
       INSTRUÇÕES:
       1. Cada elemento interativo precisa de ID
       2. O JS captura esses elementos com getElementById
       3. Event listeners são adicionados para cada um
       
       IDs OBRIGATÓRIOS (ajuste conforme sua necessidade):
       - searchInput: campo de busca
       - filterStatus: select de status
       - filterVendedor: select de vendedor (ou outro filtro)
       - btnAtualizar: botão para recarregar dados
       - btnExportar: botão para exportar CSV
       - selectionCount: span com contagem de selecionados
       - clearSelection: botão para limpar seleção
  -->
  <div class="toolbar">
    <div class="toolbar-title">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
      </svg>
      <span>Dados do banco de dados</span>
    </div>
    <div class="toolbar-spacer"></div>

    <!-- Campo de busca - ID: searchInput -->
    <div class="search-input">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/>
        <path d="m21 21-4.3-4.3"/>
      </svg>
      <input type="text" id="searchInput" placeholder="Buscar parceiro, código, nota...">
    </div>

    <!-- Filtro de status - ID: filterStatus -->
    <select class="filter-select" id="filterStatus">
      <option value="">Todos Status</option>
      <!-- Preencha conforme necessidade -->
    </select>

    <!-- Filtro adicional - ID: filterVendedor (ou outro) -->
    <select class="filter-select" id="filterVendedor">
      <!-- Será preenchido dinamicamente pelo JS -->
    </select>

    <span class="selection-count" id="selectionCount">0 selecionado(s)</span>
    <button class="btn" id="clearSelection" disabled>Limpar seleção</button>

    <!-- Botão Atualizar - ID: btnAtualizar -->
    <button class="btn btn-primary" id="btnAtualizar">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 2v6h-6"/>
        <path d="M3 12a9 9 0 0 1 15-6.7L21 8"/>
        <path d="M3 22v-6h6"/>
        <path d="M21 12a9 9 0 0 1-15 6.7L3 16"/>
      </svg>
      Atualizar
    </button>

    <!-- Botão Exportar - ID: btnExportar -->
    <button class="btn" id="btnExportar">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="7 10 12 15 17 10"/>
        <line x1="12" y1="15" x2="12" y2="3"/>
      </svg>
      Exportar CSV
    </button>
  </div>

  <!-- ═══════════════════════════════════════════════════════════════════════
       BLOCO HTML: TABELA
       ═══════════════════════════════════════════════════════════════════════
       
       REGRA CRÍTICA: data-column
       
       Cada <th> que terá filtro de coluna precisa do atributo data-column.
       Este valor DEVE ter um case correspondente no switch de getColumnValue().
       
       EXEMPLO:
       HTML: <th data-column="parceiro">
       JS:   case 'parceiro': return row.PARCEIRO || '';
       
       CHECKLIST PARA CADA COLUNA:
       □ Tem data-column?
       □ Tem case no getColumnValue()?
       □ Está sendo renderizado no renderTable()?
  -->
  <div class="table-container">
    <table class="table" id="dataTable">
      <thead>
        <tr>
          <!-- Coluna de checkbox (sem data-column) -->
          <th style="width: 40px;"><input type="checkbox" class="checkbox" id="selectAll"></th>

          <!-- Coluna com filtro: data-column="status" -->
          <th style="width: 80px;" data-column="status">
            <div class="table-header-cell">Status
              <svg class="filter-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
            </div>
            <div class="resize-handle"></div>
          </th>

          <!-- Adicione mais colunas seguindo o padrão -->
          <!-- Lembre-se: data-column deve casar com getColumnValue() -->

          <th style="width: 90px;" data-column="nunota">
            <div class="table-header-cell">Nº Único
              <svg class="filter-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
            </div>
            <div class="resize-handle"></div>
          </th>

          <th style="width: 220px;" data-column="parceiro">
            <div class="table-header-cell">Parceiro
              <svg class="filter-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
            </div>
            <div class="resize-handle"></div>
          </th>

          <th style="width: 100px;" data-column="valor">
            <div class="table-header-cell">Valor
              <svg class="filter-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
            </div>
            <div class="resize-handle"></div>
          </th>

          <!-- Continue adicionando colunas... -->
        </tr>
      </thead>
      <tbody id="tableBody">
        <!-- Dados serão inseridos via JS -->
      </tbody>
    </table>
  </div>

  <!-- Dropdown de filtro por coluna (não mexer, funciona automaticamente) -->
  <div class="column-filter-dropdown" id="columnFilterDropdown">
    <div class="column-filter-actions">
      <button class="btn btn-small" type="button" data-sort="asc">A-Z</button>
      <button class="btn btn-small" type="button" data-sort="desc">Z-A</button>
    </div>
    <div class="column-filter-search">
      <input type="text" id="columnFilterSearch" placeholder="Buscar...">
    </div>
    <div class="column-filter-selectors">
      <button class="btn btn-small" type="button" data-select="all">Todos</button>
      <button class="btn btn-small" type="button" data-select="none">Nenhum</button>
    </div>
    <div class="column-filter-list" id="columnFilterList"></div>
  </div>

  <!-- ═══════════════════════════════════════════════════════════════════════
       BLOCO HTML: PAGINAÇÃO
       ═══════════════════════════════════════════════════════════════════════
       
       REGRA: O <option selected> deve corresponder ao state.pageSize no JS
       
       Exemplo:
       HTML: <option value="100" selected>100</option>
       JS:   var state = { pageSize: 100, ... }
  -->
  <div class="pagination-bar">
    <div class="record-info">
      <span>Mostrando <span class="highlight" id="recordStart">1</span> - <span class="highlight" id="recordEnd">0</span> de <span class="highlight" id="recordTotal">0</span></span>
    </div>
    <div class="pagination-controls">
      <button class="btn-icon" id="btnFirst" title="Primeira página (Alt+Home)" disabled>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="11 17 6 12 11 7"/><polyline points="18 17 13 12 18 7"/></svg>
      </button>
      <button class="btn-icon" id="btnPrev" title="Página anterior (Alt+←)" disabled>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
      </button>
      <div class="page-indicator">
        <span>Página</span>
        <input type="number" class="page-input" id="pageInput" value="1" min="1" max="1">
        <span>de</span>
        <span class="current-page" id="totalPages">1</span>
      </div>
      <button class="btn-icon" id="btnNext" title="Próxima página (Alt+→)">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
      </button>
      <button class="btn-icon" id="btnLast" title="Última página (Alt+End)">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="13 17 18 12 13 7"/><polyline points="6 17 11 12 6 7"/></svg>
      </button>
    </div>
    <div class="page-size-container">
      <!-- ATENÇÃO: O selected aqui deve bater com state.pageSize no JS -->
      <select class="page-size-select" id="pageSize">
        <option value="50">50</option>
        <option value="100" selected>100</option>
        <option value="200">200</option>
        <option value="500">500</option>
      </select>
      <span class="page-size-label">por página</span>
    </div>
  </div>

  <!-- ═══════════════════════════════════════════════════════════════════════
       BLOCO HTML: LOADING E TOAST (OBRIGATÓRIOS)
       ═══════════════════════════════════════════════════════════════════════
       
       Estes elementos são controlados pelo JS.
       O loading começa com classe "hidden" e o JS remove/adiciona.
  -->
  <div id="loadingOverlay" class="hidden">
    <div id="loadingText">Carregando dados...</div>
  </div>
  <div id="toastContainer"></div>

  <!-- ═══════════════════════════════════════════════════════════════════════
       BIBLIOTECA SANKHYA JX
       ═══════════════════════════════════════════════════════════════════════
       
       IMPORTANTE: Este script DEVE vir ANTES do script principal!
       
       A ordem correta é:
       1. jx.min.js (biblioteca)
       2. Seu script principal
  -->
  <script src="https://cdn.jsdelivr.net/gh/wansleynery/SankhyaJX/jx.min.js"></script>

  <script>
    // ═══════════════════════════════════════════════════════════════════════
    // BLOCO JS: ESTRUTURA COMPLETA DO DASHBOARD
    // ═══════════════════════════════════════════════════════════════════════
    //
    // Este script está dividido em seções claramente identificadas.
    // Siga a ordem de implementação para evitar erros.
    //
    // ORDEM DE SEÇÕES:
    // 1. CONFIGURAÇÃO
    // 2. QUERY SQL
    // 3. ESTADO GLOBAL
    // 4. ELEMENTOS DO DOM
    // 5. FUNÇÕES AUXILIARES
    // 6. INTEGRAÇÃO JX
    // 7. PROCESSAMENTO DE DADOS
    // 8. KPIs
    // 9. FILTROS
    // 10. RENDERIZAÇÃO
    // 11. PAGINAÇÃO
    // 12. CHECKBOX
    // 13. FILTRO POR COLUNA
    // 14. RESIZE DE COLUNAS
    // 15. EXPORTAR CSV
    // 16. EVENT LISTENERS
    // 17. ATALHOS DE TECLADO
    // 18. INICIALIZAÇÃO
    // ═══════════════════════════════════════════════════════════════════════

    // ╔══════════════════════════════════════════════════════════════════════╗
    // ║ 1. CONFIGURAÇÃO                                                      ║
    // ╚══════════════════════════════════════════════════════════════════════╝
    //
    // Defina aqui parâmetros fixos da consulta.
    // Estes valores podem vir de variáveis Sankhya futuramente.

    var CONFIG = {
      CODEMP: 1,        // Código da empresa (ajuste conforme necessário)
      DEBUG: true       // true = exibe logs no console
      // Adicione outros parâmetros conforme necessidade
    };

    // ╔══════════════════════════════════════════════════════════════════════╗
    // ║ 2. QUERY SQL                                                         ║
    // ╚══════════════════════════════════════════════════════════════════════╝
    //
    // REGRA CRÍTICA: Os aliases da query (após AS) devem corresponder
    // às chaves usadas no JS para acessar os dados.
    //
    // DICA: Use nomes em MAIÚSCULA para os aliases, pois alguns bancos
    // retornam assim. O normalizarDados() vai padronizar.
    //
    // EXEMPLO:
    // SELECT CAB.NUNOTA AS NUNOTA, PAR.NOMEPARC AS PARCEIRO ...
    //
    // No JS você acessa: row.NUNOTA, row.PARCEIRO

    var SQL = 'SELECT ' +
      'CAB.NUNOTA, ' +
      'PAR.NOMEPARC AS PARCEIRO, ' +
      'CAB.VLRNOTA ' +
      // Adicione mais campos conforme necessidade
      'FROM TGFCAB CAB ' +
      'LEFT JOIN TGFPAR PAR ON CAB.CODPARC = PAR.CODPARC ' +
      'WHERE CAB.CODEMP = ' + CONFIG.CODEMP + ' ' +
      'ORDER BY CAB.NUNOTA DESC';

    // ╔══════════════════════════════════════════════════════════════════════╗
    // ║ 3. ESTADO GLOBAL                                                     ║
    // ╚══════════════════════════════════════════════════════════════════════╝
    //
    // Estas variáveis armazenam os dados e o estado atual do dashboard.

    var dadosBrutos = [];     // Dados originais vindos da consulta
    var dadosFiltrados = [];  // Dados após aplicar filtros
    var vendedoresUnicos = []; // Lista para popular filtro de vendedor (ou outro)

    // REGRA: pageSize deve corresponder ao <option selected> no HTML
    var state = {
      currentPage: 1,
      pageSize: 100,    // <- Deve bater com o HTML
      totalCount: 0,
      totalPages: 1
    };

    var columnFilters = {};
    var activeFilterColumn = null;
    var activeFilterHeader = null;

    // ╔══════════════════════════════════════════════════════════════════════╗
    // ║ 4. ELEMENTOS DO DOM                                                  ║
    // ╚══════════════════════════════════════════════════════════════════════╝
    //
    // REGRA CRÍTICA: Cada getElementById aqui precisa ter um elemento
    // correspondente no HTML com o mesmo ID (case-sensitive).
    //
    // Se o ID não existir, a variável será null e o JS vai quebrar.
    //
    // CHECKLIST: Para cada linha abaixo, verifique se o ID existe no HTML.

    var tableBody = document.getElementById('tableBody');
    var selectAllCheckbox = document.getElementById('selectAll');
    var pageInput = document.getElementById('pageInput');
    var pageSizeSelect = document.getElementById('pageSize');
    var btnFirst = document.getElementById('btnFirst');
    var btnPrev = document.getElementById('btnPrev');
    var btnNext = document.getElementById('btnNext');
    var btnLast = document.getElementById('btnLast');
    var recordStart = document.getElementById('recordStart');
    var recordEnd = document.getElementById('recordEnd');
    var recordTotal = document.getElementById('recordTotal');
    var totalPagesEl = document.getElementById('totalPages');
    var selectionCountEl = document.getElementById('selectionCount');
    var clearSelectionBtn = document.getElementById('clearSelection');
    var columnFilterDropdown = document.getElementById('columnFilterDropdown');
    var columnFilterList = document.getElementById('columnFilterList');
    var columnFilterSearch = document.getElementById('columnFilterSearch');
    var searchInput = document.getElementById('searchInput');
    var filterStatus = document.getElementById('filterStatus');
    var filterVendedor = document.getElementById('filterVendedor');
    var loadingOverlay = document.getElementById('loadingOverlay');
    var loadingText = document.getElementById('loadingText');
    var toastContainer = document.getElementById('toastContainer');

    // ╔══════════════════════════════════════════════════════════════════════╗
    // ║ 5. FUNÇÕES AUXILIARES                                                ║
    // ╚══════════════════════════════════════════════════════════════════════╝

    function debug(msg, data) {
      if (CONFIG.DEBUG) {
        if (data !== undefined) {
          console.log('[DEBUG] ' + msg, data);
        } else {
          console.log('[DEBUG] ' + msg);
        }
      }
    }

    function loading(show, texto) {
      if (show) {
        loadingOverlay.classList.remove('hidden');
        loadingText.textContent = texto || 'Carregando dados...';
      } else {
        loadingOverlay.classList.add('hidden');
      }
    }

    function toast(mensagem, tipo) {
      var toastEl = document.createElement('div');
      toastEl.className = 'toast toast-' + (tipo || 'info');
      toastEl.textContent = mensagem;
      toastContainer.appendChild(toastEl);
      setTimeout(function() { toastEl.remove(); }, 4000);
    }

    function formatCurrency(value) {
      var num = parseFloat(value) || 0;
      return num.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // Gera iniciais do nome (ex.: "João Silva" → "JS")
    function gerarIniciais(nome) {
      if (!nome) return '??';
      var partes = nome.trim().split(' ');
      if (partes.length >= 2) {
        return (partes[0].charAt(0) + partes[partes.length - 1].charAt(0)).toUpperCase();
      }
      return nome.substring(0, 2).toUpperCase();
    }

    // Gera cor baseada no nome (para avatar)
    function gerarCorAvatar(nome) {
      if (!nome) return 'hsl(200, 70%, 50%)';
      var hash = 0;
      for (var i = 0; i < nome.length; i++) {
        hash = nome.charCodeAt(i) + ((hash << 5) - hash);
      }
      var hue = Math.abs(hash % 360);
      return 'hsl(' + hue + ', 65%, 45%)';
    }

    // ╔══════════════════════════════════════════════════════════════════════╗
    // ║ 6. INTEGRAÇÃO JX                                                     ║
    // ╚══════════════════════════════════════════════════════════════════════╝
    //
    // LIÇÃO APRENDIDA: Em ambiente Sankhya embed, o JX pode estar em:
    // - window (quando carregado diretamente)
    // - window.parent (quando em iframe)
    // - window.top (quando em iframe aninhado)
    //
    // A função getJXRef() busca em todos esses lugares.

    function getJXRef() {
      if (typeof JX !== 'undefined') return JX;
      if (window.parent && window.parent.JX) return window.parent.JX;
      if (window.top && window.top.JX) return window.top.JX;
      return undefined;
    }

    function carregarDadosSankhya() {
      debug('Iniciando carregamento de dados...');
      debug('SQL:', SQL);

      var jxRef = getJXRef();

      if (typeof jxRef === 'undefined') {
        debug('JX não disponível');
        toast('Erro: JX não disponível', 'erro');
        dadosBrutos = [];
        dadosFiltrados = [];
        atualizarInterface();
        return;
      }

      if (typeof jxRef.consultar !== 'function') {
        debug('JX.consultar não é função');
        toast('Erro: JX.consultar não disponível', 'erro');
        dadosBrutos = [];
        dadosFiltrados = [];
        atualizarInterface();
        return;
      }

      loading(true, 'Consultando banco de dados...');

      jxRef.consultar(SQL)
        .then(function(dados) {
          loading(false);
          debug('Retorno da consulta - Tipo:', typeof dados);

          dadosBrutos = extrairDadosRetorno(dados);
          dadosBrutos = normalizarDados(dadosBrutos);
          debug('Total de registros:', dadosBrutos.length);

          if (dadosBrutos.length > 0) {
            debug('Primeiro registro:', dadosBrutos[0]);
            processarDados();
            toast(dadosBrutos.length + ' registros carregados', 'sucesso');
          } else {
            toast('Nenhum registro encontrado', 'info');
            dadosFiltrados = [];
            atualizarInterface();
          }
        })
        .catch(function(erro) {
          loading(false);
          debug('Erro na consulta:', erro);
          var msgErro = erro && erro.message ? erro.message : String(erro);
          toast('Erro: ' + msgErro, 'erro');
          dadosBrutos = [];
          dadosFiltrados = [];
          atualizarInterface();
        });
    }

    // LIÇÃO APRENDIDA: O retorno do JX pode vir em diferentes formatos
    function extrairDadosRetorno(dados) {
      if (dados === null || dados === undefined) return [];
      if (Array.isArray(dados)) return dados;
      if (typeof dados === 'object') {
        if (dados.result && Array.isArray(dados.result)) return dados.result;
        if (dados.data && Array.isArray(dados.data)) return dados.data;
        if (dados.rows && Array.isArray(dados.rows)) return dados.rows;
        var keys = Object.keys(dados);
        for (var i = 0; i < keys.length; i++) {
          if (Array.isArray(dados[keys[i]])) return dados[keys[i]];
        }
      }
      return [];
    }

    // LIÇÃO APRENDIDA: Chaves podem vir maiúsculas ou minúsculas
    // Esta função padroniza para MAIÚSCULA
    function normalizarDados(lista) {
      if (!Array.isArray(lista)) return [];
      var normalizados = [];
      for (var i = 0; i < lista.length; i++) {
        var row = lista[i] || {};
        // AJUSTE AQUI: Adicione todos os campos da sua query
        normalizados.push({
          NUNOTA: row.NUNOTA !== undefined ? row.NUNOTA : row.nunota,
          PARCEIRO: row.PARCEIRO !== undefined ? row.PARCEIRO : row.parceiro,
          VLRNOTA: row.VLRNOTA !== undefined ? row.VLRNOTA : row.vlrnota
          // Adicione mais campos conforme sua query
        });
      }
      return normalizados;
    }

    // ╔══════════════════════════════════════════════════════════════════════╗
    // ║ 7. PROCESSAMENTO DE DADOS                                            ║
    // ╚══════════════════════════════════════════════════════════════════════╝
    //
    // Esta função é chamada após carregar os dados.
    // Aqui você pode:
    // - Calcular campos derivados (ex.: _iniciais, _cor)
    // - Popular listas para filtros (ex.: vendedoresUnicos)

    function processarDados() {
      debug('Processando dados...');

      // Exemplo: popular lista de vendedores únicos
      vendedoresUnicos = [];
      var vendedoresMap = {};

      for (var i = 0; i < dadosBrutos.length; i++) {
        var row = dadosBrutos[i];

        // Campos derivados (calculados a partir dos dados)
        row._iniciais = gerarIniciais(row.PARCEIRO);
        row._cor = gerarCorAvatar(row.PARCEIRO);

        // Exemplo: extrair vendedores únicos
        // Ajuste conforme seu campo
        var vendedor = row.VENDEDOR || 'SEM VENDEDOR';
        row._vendedor = vendedor;
        if (!vendedoresMap[vendedor]) {
          vendedoresMap[vendedor] = true;
          vendedoresUnicos.push(vendedor);
        }
      }

      vendedoresUnicos.sort();
      popularFiltroVendedor();

      dadosFiltrados = dadosBrutos.slice();
      atualizarInterface();
    }

    function popularFiltroVendedor() {
      var html = '<option value="">Todos Vendedores</option>';
      for (var i = 0; i < vendedoresUnicos.length; i++) {
        html += '<option value="' + vendedoresUnicos[i] + '">' + vendedoresUnicos[i] + '</option>';
      }
      filterVendedor.innerHTML = html;
    }

    function atualizarInterface() {
      calcularKPIs();
      state.totalCount = dadosFiltrados.length;
      state.currentPage = 1;
      updatePagination();
      renderTable();
    }

    // ╔══════════════════════════════════════════════════════════════════════╗
    // ║ 8. KPIs                                                              ║
    // ╚══════════════════════════════════════════════════════════════════════╝
    //
    // REGRA: Os IDs usados aqui (kpiTotal, kpiValor, etc.) devem existir no HTML

    function calcularKPIs() {
      var total = dadosFiltrados.length;
      var valorTotal = 0;

      for (var i = 0; i < dadosFiltrados.length; i++) {
        var row = dadosFiltrados[i];
        valorTotal += parseFloat(row.VLRNOTA) || 0;
        // Adicione mais cálculos conforme necessidade
      }

      // AJUSTE: Use os IDs corretos do seu HTML
      document.getElementById('kpiTotal').textContent = total;
      document.getElementById('kpiValor').textContent = 'R$ ' + formatCurrency(valorTotal);
      // Adicione mais KPIs conforme necessidade
    }

    // ╔══════════════════════════════════════════════════════════════════════╗
    // ║ 9. FILTROS                                                           ║
    // ╚══════════════════════════════════════════════════════════════════════╝

    function aplicarFiltros() {
      var termoBusca = (searchInput.value || '').toLowerCase().trim();
      var statusSel = filterStatus.value;
      var vendedorSel = filterVendedor.value;

      dadosFiltrados = dadosBrutos.filter(function(row) {
        // Filtro de busca
        if (termoBusca) {
          var campos = [
            String(row.NUNOTA || ''),
            (row.PARCEIRO || '').toLowerCase()
            // Adicione mais campos para busca
          ].join(' ');
          if (campos.indexOf(termoBusca) === -1) {
            return false;
          }
        }

        // Filtro de status
        if (statusSel && row._status !== statusSel) {
          return false;
        }

        // Filtro de vendedor
        if (vendedorSel && (row._vendedor || '') !== vendedorSel) {
          return false;
        }

        return true;
      });

      atualizarInterface();
    }

    // ╔══════════════════════════════════════════════════════════════════════╗
    // ║ 10. RENDERIZAÇÃO DA TABELA                                           ║
    // ╚══════════════════════════════════════════════════════════════════════╝
    //
    // REGRA: Cada <td> aqui deve corresponder a uma coluna do <thead>

    function renderTable() {
      var startIndex = (state.currentPage - 1) * state.pageSize;
      var endIndex = Math.min(startIndex + state.pageSize, state.totalCount);
      var pageData = dadosFiltrados.slice(startIndex, endIndex);

      var html = '';
      for (var i = 0; i < pageData.length; i++) {
        var row = pageData[i];

        html += '<tr>';
        html += '<td><input type="checkbox" class="checkbox row-checkbox" data-id="' + row.NUNOTA + '"></td>';
        html += '<td><span class="badge badge-pendente">Status</span></td>';
        html += '<td>' + (row.NUNOTA || '') + '</td>';
        html += '<td><div class="partner-cell">';
        html += '<div class="avatar" style="background-color: ' + row._cor + ';">' + row._iniciais + '</div>';
        html += '<span class="partner-name">' + (row.PARCEIRO || '') + '</span>';
        html += '</div></td>';
        html += '<td><span class="value-positive">R$ ' + formatCurrency(row.VLRNOTA) + '</span></td>';
        // Adicione mais colunas conforme necessidade
        html += '</tr>';
      }

      if (pageData.length === 0) {
        html = '<tr><td colspan="100" style="text-align: center; padding: 2rem; color: var(--muted-foreground);">Nenhum registro encontrado</td></tr>';
      }

      tableBody.innerHTML = html;
      bindRowCheckboxes();
      updateSelectAllState();
    }

    // ╔══════════════════════════════════════════════════════════════════════╗
    // ║ 11. PAGINAÇÃO                                                        ║
    // ╚══════════════════════════════════════════════════════════════════════╝

    function updatePagination() {
      state.totalPages = Math.ceil(state.totalCount / state.pageSize);
      if (state.totalPages < 1) state.totalPages = 1;
      if (state.currentPage > state.totalPages) state.currentPage = state.totalPages;

      var startRecord = state.totalCount === 0 ? 0 : (state.currentPage - 1) * state.pageSize + 1;
      var endRecord = state.totalCount === 0 ? 0 : Math.min(state.currentPage * state.pageSize, state.totalCount);

      recordStart.textContent = startRecord.toLocaleString('pt-BR');
      recordEnd.textContent = endRecord.toLocaleString('pt-BR');
      recordTotal.textContent = state.totalCount.toLocaleString('pt-BR');

      pageInput.value = state.currentPage;
      pageInput.max = state.totalPages;
      totalPagesEl.textContent = state.totalPages;

      btnFirst.disabled = state.currentPage === 1;
      btnPrev.disabled = state.currentPage === 1;
      btnNext.disabled = state.currentPage === state.totalPages;
      btnLast.disabled = state.currentPage === state.totalPages;
    }

    function goToPage(page) {
      var newPage = Math.max(1, Math.min(page, state.totalPages));
      if (newPage !== state.currentPage) {
        state.currentPage = newPage;
        updatePagination();
        renderTable();
      }
    }

    function goToFirst() { goToPage(1); }
    function goToPrev() { goToPage(state.currentPage - 1); }
    function goToNext() { goToPage(state.currentPage + 1); }
    function goToLast() { goToPage(state.totalPages); }

    // ╔══════════════════════════════════════════════════════════════════════╗
    // ║ 12. CHECKBOX                                                         ║
    // ╚══════════════════════════════════════════════════════════════════════╝

    function bindRowCheckboxes() {
      var rowCheckboxes = document.querySelectorAll('.row-checkbox');
      for (var i = 0; i < rowCheckboxes.length; i++) {
        rowCheckboxes[i].addEventListener('change', function() {
          var row = this.closest('tr');
          if (row) {
            if (this.checked) {
              row.classList.add('selected');
            } else {
              row.classList.remove('selected');
            }
          }
          updateSelectAllState();
        });
      }
    }

    function updateSelectAllState() {
      var rowCheckboxes = document.querySelectorAll('.row-checkbox');
      var allChecked = true;
      var someChecked = false;
      var selectedCount = 0;

      for (var i = 0; i < rowCheckboxes.length; i++) {
        if (rowCheckboxes[i].checked) {
          someChecked = true;
          selectedCount++;
        } else {
          allChecked = false;
        }
      }

      selectAllCheckbox.checked = allChecked && rowCheckboxes.length > 0;
      selectAllCheckbox.indeterminate = someChecked && !allChecked;
      if (selectionCountEl) {
        selectionCountEl.textContent = selectedCount + ' selecionado(s)';
      }
      if (clearSelectionBtn) {
        clearSelectionBtn.disabled = selectedCount === 0;
      }
    }

    selectAllCheckbox.addEventListener('change', function() {
      var rowCheckboxes = document.querySelectorAll('.row-checkbox');
      for (var i = 0; i < rowCheckboxes.length; i++) {
        rowCheckboxes[i].checked = selectAllCheckbox.checked;
        var row = rowCheckboxes[i].closest('tr');
        if (row) {
          if (selectAllCheckbox.checked) {
            row.classList.add('selected');
          } else {
            row.classList.remove('selected');
          }
        }
      }
      updateSelectAllState();
    });

    if (clearSelectionBtn) {
      clearSelectionBtn.addEventListener('click', function() {
        var rowCheckboxes = document.querySelectorAll('.row-checkbox');
        for (var i = 0; i < rowCheckboxes.length; i++) {
          rowCheckboxes[i].checked = false;
          var row = rowCheckboxes[i].closest('tr');
          if (row) row.classList.remove('selected');
        }
        updateSelectAllState();
      });
    }

    // ╔══════════════════════════════════════════════════════════════════════╗
    // ║ 13. FILTRO POR COLUNA                                                ║
    // ╚══════════════════════════════════════════════════════════════════════╝
    //
    // REGRA CRÍTICA: Cada case deste switch DEVE corresponder a um
    // data-column existente no <th> do HTML.

    function getColumnValue(row, columnKey) {
      switch (columnKey) {
        case 'status': return row._status || 'Pendente';
        case 'nunota': return String(row.NUNOTA || '');
        case 'parceiro': return row.PARCEIRO || '';
        case 'valor': return 'R$ ' + formatCurrency(row.VLRNOTA);
        // Adicione mais cases conforme as colunas do seu HTML
        default: return '';
      }
    }

    function getUniqueValues(columnKey) {
      var unique = {};
      for (var i = 0; i < dadosBrutos.length; i++) {
        var value = getColumnValue(dadosBrutos[i], columnKey);
        if (!unique[value]) unique[value] = true;
      }
      var values = [];
      for (var key in unique) {
        if (unique.hasOwnProperty(key)) values.push(key);
      }
      return values;
    }

    function ensureFilterState(columnKey, values) {
      if (!columnFilters[columnKey]) {
        var selected = {};
        for (var i = 0; i < values.length; i++) {
          selected[values[i]] = true;
        }
        columnFilters[columnKey] = { selected: selected, sort: 'asc', search: '' };
      } else {
        for (var j = 0; j < values.length; j++) {
          if (columnFilters[columnKey].selected[values[j]] === undefined) {
            columnFilters[columnKey].selected[values[j]] = true;
          }
        }
      }
    }

    function getSortedValues(values, sort) {
      var list = values.slice();
      list.sort(function(a, b) {
        var aVal = a.toLowerCase();
        var bVal = b.toLowerCase();
        if (aVal < bVal) return sort === 'desc' ? 1 : -1;
        if (aVal > bVal) return sort === 'desc' ? -1 : 1;
        return 0;
      });
      return list;
    }

    function renderFilterList(columnKey) {
      var values = getUniqueValues(columnKey);
      ensureFilterState(columnKey, values);
      var filter = columnFilters[columnKey];
      var sortedValues = getSortedValues(values, filter.sort);
      var searchText = filter.search.toLowerCase();
      var html = '';

      for (var i = 0; i < sortedValues.length; i++) {
        var value = sortedValues[i];
        if (searchText && value.toLowerCase().indexOf(searchText) === -1) continue;
        var checked = filter.selected[value] ? ' checked' : '';
        html += '<label class="column-filter-item">' +
          '<input type="checkbox" class="column-filter-checkbox" data-value="' + value + '"' + checked + '>' +
          '<span>' + value + '</span>' +
          '</label>';
      }

      columnFilterList.innerHTML = html;
      var checkboxes = columnFilterList.querySelectorAll('.column-filter-checkbox');
      for (var j = 0; j < checkboxes.length; j++) {
        checkboxes[j].addEventListener('change', function() {
          var val = this.getAttribute('data-value');
          columnFilters[columnKey].selected[val] = this.checked;
          applyColumnFilters();
        });
      }
    }

    function applyColumnFilters() {
      dadosFiltrados = dadosBrutos.filter(function(row) {
        for (var key in columnFilters) {
          if (!columnFilters.hasOwnProperty(key)) continue;
          var value = getColumnValue(row, key);
          if (!columnFilters[key].selected[value]) {
            return false;
          }
        }
        return true;
      });
      state.totalCount = dadosFiltrados.length;
      state.currentPage = 1;
      calcularKPIs();
      updatePagination();
      renderTable();
    }

    function openColumnFilter(headerEl, columnKey) {
      activeFilterHeader = headerEl;
      activeFilterColumn = columnKey;
      renderFilterList(columnKey);
      columnFilterSearch.value = columnFilters[columnKey].search || '';
      columnFilterDropdown.classList.add('open');

      var rect = headerEl.getBoundingClientRect();
      var dropdownWidth = columnFilterDropdown.offsetWidth || 240;
      var left = rect.left + window.scrollX;
      var top = rect.bottom + window.scrollY + 6;
      if (left + dropdownWidth > window.innerWidth) {
        left = window.innerWidth - dropdownWidth - 8;
      }
      if (left < 8) left = 8;
      columnFilterDropdown.style.left = left + 'px';
      columnFilterDropdown.style.top = top + 'px';
    }

    function closeColumnFilter() {
      activeFilterColumn = null;
      activeFilterHeader = null;
      columnFilterDropdown.classList.remove('open');
    }

    function initColumnFilters() {
      var headerCells = document.querySelectorAll('th[data-column] .table-header-cell');
      for (var i = 0; i < headerCells.length; i++) {
        headerCells[i].addEventListener('click', function(e) {
          var th = this.closest('th');
          if (!th || !th.dataset.column) return;
          if (e.target.classList.contains('resize-handle')) return;
          e.stopPropagation();
          if (activeFilterColumn === th.dataset.column && columnFilterDropdown.classList.contains('open')) {
            closeColumnFilter();
            return;
          }
          openColumnFilter(th, th.dataset.column);
        });
      }

      columnFilterDropdown.addEventListener('click', function(e) {
        e.stopPropagation();
      });

      document.addEventListener('click', function() {
        if (columnFilterDropdown.classList.contains('open')) {
          closeColumnFilter();
        }
      });

      columnFilterSearch.addEventListener('input', function() {
        if (!activeFilterColumn) return;
        columnFilters[activeFilterColumn].search = columnFilterSearch.value;
        renderFilterList(activeFilterColumn);
      });

      var sortButtons = columnFilterDropdown.querySelectorAll('[data-sort]');
      for (var j = 0; j < sortButtons.length; j++) {
        sortButtons[j].addEventListener('click', function() {
          if (!activeFilterColumn) return;
          columnFilters[activeFilterColumn].sort = this.getAttribute('data-sort');
          renderFilterList(activeFilterColumn);
        });
      }

      var selectButtons = columnFilterDropdown.querySelectorAll('[data-select]');
      for (var k = 0; k < selectButtons.length; k++) {
        selectButtons[k].addEventListener('click', function() {
          if (!activeFilterColumn) return;
          var values = getUniqueValues(activeFilterColumn);
          var mode = this.getAttribute('data-select');
          for (var i2 = 0; i2 < values.length; i2++) {
            columnFilters[activeFilterColumn].selected[values[i2]] = mode === 'all';
          }
          renderFilterList(activeFilterColumn);
          applyColumnFilters();
        });
      }
    }

    // ╔══════════════════════════════════════════════════════════════════════╗
    // ║ 14. RESIZE DE COLUNAS                                                ║
    // ╚══════════════════════════════════════════════════════════════════════╝

    function initColumnResize() {
      var resizeHandles = document.querySelectorAll('.resize-handle');

      for (var i = 0; i < resizeHandles.length; i++) {
        (function(handle) {
          var isResizing = false;
          var startX = 0;
          var startWidth = 0;
          var th = null;

          handle.addEventListener('mousedown', function(e) {
            isResizing = true;
            th = handle.parentElement;
            startX = e.pageX;
            startWidth = th.offsetWidth;
            handle.classList.add('active');
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
            e.preventDefault();
          });

          document.addEventListener('mousemove', function(e) {
            if (!isResizing) return;
            var width = startWidth + (e.pageX - startX);
            if (width >= 50) {
              th.style.width = width + 'px';
            }
          });

          document.addEventListener('mouseup', function() {
            if (isResizing) {
              isResizing = false;
              handle.classList.remove('active');
              document.body.style.cursor = '';
              document.body.style.userSelect = '';
            }
          });
        })(resizeHandles[i]);
      }
    }

    // ╔══════════════════════════════════════════════════════════════════════╗
    // ║ 15. EXPORTAR CSV                                                     ║
    // ╚══════════════════════════════════════════════════════════════════════╝

    function exportarCSV() {
      if (dadosFiltrados.length === 0) {
        toast('Nenhum dado para exportar', 'info');
        return;
      }

      // AJUSTE: Defina os cabeçalhos conforme suas colunas
      var headers = ['Nº Único', 'Parceiro', 'Valor'];
      var linhas = [headers.join(';')];

      for (var i = 0; i < dadosFiltrados.length; i++) {
        var row = dadosFiltrados[i];
        var linha = [
          row.NUNOTA || '',
          (row.PARCEIRO || '').replace(/;/g, ','),
          formatCurrency(row.VLRNOTA).replace('.', '')
          // Adicione mais campos
        ];
        linhas.push(linha.join(';'));
      }

      var conteudo = linhas.join('\n');
      var blob = new Blob(['\ufeff' + conteudo], { type: 'text/csv;charset=utf-8;' });
      var url = URL.createObjectURL(blob);
      var link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', 'exportacao_' + new Date().toISOString().slice(0, 10) + '.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      toast('CSV exportado com sucesso', 'sucesso');
    }

    // ╔══════════════════════════════════════════════════════════════════════╗
    // ║ 16. EVENT LISTENERS                                                  ║
    // ╚══════════════════════════════════════════════════════════════════════╝

    btnFirst.addEventListener('click', goToFirst);
    btnPrev.addEventListener('click', goToPrev);
    btnNext.addEventListener('click', goToNext);
    btnLast.addEventListener('click', goToLast);

    pageInput.addEventListener('change', function() {
      var page = parseInt(pageInput.value);
      if (!isNaN(page)) {
        goToPage(page);
      }
    });

    pageSizeSelect.addEventListener('change', function() {
      state.pageSize = parseInt(pageSizeSelect.value);
      state.currentPage = 1;
      updatePagination();
      renderTable();
    });

    searchInput.addEventListener('input', function() {
      aplicarFiltros();
    });

    filterStatus.addEventListener('change', function() {
      aplicarFiltros();
    });

    filterVendedor.addEventListener('change', function() {
      aplicarFiltros();
    });

    document.getElementById('btnAtualizar').addEventListener('click', function() {
      carregarDadosSankhya();
    });

    document.getElementById('btnExportar').addEventListener('click', function() {
      exportarCSV();
    });

    // ╔══════════════════════════════════════════════════════════════════════╗
    // ║ 17. ATALHOS DE TECLADO                                               ║
    // ╚══════════════════════════════════════════════════════════════════════╝

    document.addEventListener('keydown', function(e) {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;

      if (e.altKey) {
        switch (e.key) {
          case 'ArrowLeft':
            e.preventDefault();
            goToPrev();
            break;
          case 'ArrowRight':
            e.preventDefault();
            goToNext();
            break;
          case 'Home':
            e.preventDefault();
            goToFirst();
            break;
          case 'End':
            e.preventDefault();
            goToLast();
            break;
        }
      }
    });

    // ╔══════════════════════════════════════════════════════════════════════╗
    // ║ 18. INICIALIZAÇÃO                                                    ║
    // ╚══════════════════════════════════════════════════════════════════════╝

    function init() {
      debug('═══════════════════════════════════════════');
      debug('DASHBOARD INICIALIZANDO');
      debug('═══════════════════════════════════════════');

      initColumnResize();
      initColumnFilters();

      // Carrega dados do banco
      carregarDadosSankhya();

      console.log('Dashboard carregado!');
      console.log('Atalhos: Alt+← (anterior), Alt+→ (próxima), Alt+Home (primeira), Alt+End (última)');
    }

    init();
  </script>

</body>
</html>
