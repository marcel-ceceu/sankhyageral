<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Menu Geral de Telas - Auto PeÃ§as SÃ£o Paulo</title>

    <!-- Core CSS -->
    <!-- Custom CSS -->
        <style>
/* ==========================================================
   VARIABLES - APESP Core
   ========================================================== */

:root {
    --ap-foreground: #0f172a;
    --ap-muted-foreground: #64748b;
    --ap-border: #e5e7eb;
    --ap-surface: #ffffff;
    --ap-surface-muted: #f8fafc;
    --ap-shadow: rgba(15, 23, 42, 0.15);
    --ap-accent: #1e40af;
}


/* ==========================================================
   BASE - Reset e Tipografia
   ========================================================== */

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

html {
    width: 100%;
    height: 100%;
    overflow-x: hidden;
    -webkit-text-size-adjust: 100%;
    -ms-text-size-adjust: 100%;
}

body {
    font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--ap-surface);
    min-height: 100vh;
    width: 100%;
    padding: 0;
    margin: 0;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}


/* ==========================================================
   LAYOUT - Container, Header, Grid
   ========================================================== */

.container {
    width: 100%;
    max-width: 100%;
    margin: 0;
    background: var(--ap-surface);
    min-height: 100vh;
    overflow-x: hidden;
    overflow-y: auto;
    position: relative;
    display: flex;
    flex-direction: column;
}

.header {
    background: linear-gradient(135deg,
        rgba(30, 58, 138, 0.15) 0%,
        rgba(30, 64, 175, 0.12) 25%,
        rgba(37, 99, 235, 0.1) 50%,
        rgba(30, 64, 175, 0.12) 75%,
        rgba(30, 58, 138, 0.15) 100%);
    padding: 16px 24px;
    border-bottom: 3px solid rgba(15, 23, 42, 0.25);
    position: relative;
    z-index: 1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    box-shadow: 0 4px 12px rgba(15, 23, 42, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

.header-left {
    display: flex;
    align-items: center;
    gap: 20px;
}

.header-logo {
    height: 116px;
    width: auto;
    border-radius: 6px;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
}

.header-titulo {
    display: flex;
    align-items: center;
    gap: 12px;
    color: #0f172a;
    font-size: 32px;
    font-weight: 800;
    letter-spacing: -0.5px;
    text-shadow: 0 2px 4px rgba(255, 255, 255, 0.9),
                 0 1px 2px rgba(30, 58, 138, 0.1);
    line-height: 1;
}

.header-titulo::before {
    content: '';
    display: inline-block;
    width: 5px;
    height: 50px;
    background: linear-gradient(180deg, #0f172a 0%, #1e3a8a 50%, #1e40af 100%);
    border-radius: 4px;
    box-shadow: 0 2px 6px rgba(15, 23, 42, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.header-emoji {
    display: none;
}

.header-right {
    color: #334155;
    font-size: 16px;
    font-weight: 700;
    letter-spacing: 0.4px;
    display: flex;
    align-items: center;
    gap: 10px;
    text-shadow: 0 1px 3px rgba(255, 255, 255, 0.8),
                 0 1px 2px rgba(30, 58, 138, 0.1);
}

.header-right::before {
    content: '';
    width: 8px;
    height: 8px;
    background: radial-gradient(circle, #1e40af 0%, #0f172a 100%);
    border-radius: 50%;
    box-shadow: 0 2px 6px rgba(15, 23, 42, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
}

.content {
    padding: 32px 24px;
    position: relative;
    z-index: 1;
    background: rgba(250, 250, 250, 0.95);
    flex: 1;
    width: 100%;
}

.grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 20px;
    max-width: 100%;
    width: 100%;
    margin: 0 auto;
}

@media (min-width: 1200px) {
    .grid {
        grid-template-columns: repeat(5, 1fr);
    }
}

@media (max-width: 900px) {
    .grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (max-width: 600px) {
    .grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (min-width: 800px) and (max-width: 1199px) {
    .grid {
        grid-template-columns: repeat(4, 1fr);
    }
    .content {
        padding: 28px 20px;
    }
    .header, .versiculo-bar {
        padding-left: 20px;
        padding-right: 20px;
    }
}


/* ==========================================================
   BUTTONS - BotÃµes e Spinner
   ========================================================== */

.btn {
    border: 0;
    border-radius: 8px;
    padding: 11px 20px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s;
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-secondary {
    background: #f3f4f6;
    color: #374151;
}

.btn-secondary:hover:not(:disabled) {
    background: #e5e7eb;
}

.btn-primary {
    background: #0f172a;
    color: #fff;
}

.btn-primary:hover:not(:disabled) {
    background: #1e40af;
}

.spinner {
    width: 16px;
    height: 16px;
    border: 2px solid #e5e7eb;
    border-top-color: #0f172a;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
    display: none;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}


/* ==========================================================
   MODAL - Estrutura de Modais
   ========================================================== */

.modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 16px;
    z-index: 9999;
    backdrop-filter: blur(2px);
}

.modal {
    width: 100%;
    max-width: 720px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.15);
    padding: 24px;
    max-height: 88vh;
    overflow: auto;
}

.modal h3 {
    margin: 0 0 12px 0;
    font-size: 18px;
    color: #1e293b;
    font-weight: 600;
    letter-spacing: -0.3px;
}

.modal p {
    margin: 0 0 16px 0;
    font-size: 14px;
    color: #64748b;
    line-height: 1.5;
}

.modal input {
    width: 100%;
    padding: 12px 14px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    outline: none;
    font-size: 14px;
    box-sizing: border-box;
    transition: all 0.2s;
}

.modal input:focus {
    border-color: #0f172a;
    box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.1);
}

.modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
    align-items: center;
}


/* ==========================================================
   CUSTOM - Menu Geral APESP
   ========================================================== */

/* Marca d'Ã¡gua Logo APESP */
.watermark {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 500px;
    height: 500px;
    background-image: url('https://i.ibb.co/bhVrHGM/1.png');
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    opacity: 0.06;
    z-index: 0;
    pointer-events: none;
}

.menu-item {
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 29px 19px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    color: inherit;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 168px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.menu-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    border-color: #0f172a;
}

.menu-item.active {
    border-color: #0f172a;
    background: #f8fafc;
    border-width: 2px;
}

.menu-item.active:hover {
    border-color: #1e40af;
}

.menu-item.em-construcao {
    opacity: 0.5;
    cursor: not-allowed;
    background: #fafafa;
}

.menu-item.em-construcao:hover {
    transform: none;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    border-color: #e5e7eb;
}

.icon-wrapper {
    width: 67px;
    height: 67px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 17px;
    border-radius: 10px;
    background: #f3f4f6;
}

.menu-item.active .icon-wrapper {
    background: #e2e8f0;
}

.menu-item.em-construcao .icon-wrapper {
    background: #f5f5f5;
}

.icon-wrapper svg {
    width: 38px;
    height: 38px;
}

.icon-wrapper img {
    width: 67px !important;
    height: 67px !important;
}

.menu-item span {
    font-size: 16px;
    font-weight: 500;
    color: #374151;
    line-height: 1.4;
}

.menu-item.active span {
    color: #0f172a;
    font-weight: 600;
}

.menu-item.em-construcao span {
    color: #9ca3af;
}

/* VersÃ­culo bÃ­blico */
.versiculo-bar {
    background: #ffffff;
    padding: 20px 24px;
    position: relative;
    z-index: 1;
    border-bottom: 2px solid #e5e7eb;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08),
                0 2px 4px rgba(0, 0, 0, 0.06),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
    width: 100%;
}

.versiculo-content {
    display: flex;
    align-items: center;
    gap: 20px;
    max-width: 100%;
    width: 100%;
    margin: 0 auto;
}

.versiculo-icone {
    font-size: 26px;
    opacity: 0.8;
    filter: drop-shadow(2px 2px 3px rgba(0, 0, 0, 0.15));
}

.versiculo-texto {
    flex: 1;
    font-size: 18px;
    font-style: italic;
    color: #1e293b;
    line-height: 1.6;
    font-weight: 700;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
}

.versiculo-ref {
    font-style: normal;
    font-weight: 800;
    color: #0f172a;
    margin-left: 10px;
    white-space: nowrap;
    text-shadow: 1px 1px 2px rgba(15, 23, 42, 0.2);
}

.versiculo-btn {
    background: #ffffff;
    border: 2px solid #e5e7eb;
    color: #0f172a;
    width: 42px;
    height: 42px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 18px;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
}

.versiculo-btn:hover {
    background: #f1f5f9;
    border-color: #0f172a;
    transform: rotate(180deg) scale(1.05);
    box-shadow: 0 4px 10px rgba(15, 23, 42, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
}

/* Resultado visual */
.resultado-shell {
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid #e5e7eb;
    background: #fff;
}

.resultado-hero {
    padding: 20px;
    background: #0f172a;
    color: #fff;
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 16px;
    align-items: center;
}

.hero-title {
    font-size: 14px;
    font-weight: 900;
    letter-spacing: 0.4px;
    margin-bottom: 4px;
    opacity: 0.95;
}

.hero-sub {
    font-size: 12px;
    opacity: 0.9;
    line-height: 1.4;
}

.badge-status {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 10px;
    border-radius: 999px;
    background: rgba(255,255,255,0.16);
    border: 1px solid rgba(255,255,255,0.22);
    font-size: 12px;
    font-weight: 800;
    white-space: nowrap;
    justify-self: end;
}

.resultado-body {
    padding: 14px;
    background: #f8f9fa;
}

.sec-grid {
    display: grid;
    grid-template-columns: 1.2fr 0.8fr;
    gap: 12px;
}

@media (max-width: 560px) {
    .sec-grid { grid-template-columns: 1fr; }
    .resultado-hero { grid-template-columns: 1fr; }
    .badge-status { justify-self: start; }
}

.card {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 16px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

.card h4 {
    margin: 0 0 12px 0;
    font-size: 13px;
    color: #1e293b;
    font-weight: 600;
    letter-spacing: 0.3px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.kv-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}

@media (max-width: 560px) {
    .kv-grid { grid-template-columns: 1fr; }
}

.kv {
    border: 1px solid #f3f4f6;
    background: #f9fafb;
    border-radius: 8px;
    padding: 12px;
}

.k {
    font-size: 11px;
    color: #6b7280;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.v {
    font-size: 14px;
    color: #1e293b;
    font-weight: 600;
    line-height: 1.3;
    word-break: break-word;
}

.v small {
    display: block;
    margin-top: 6px;
    font-size: 12px;
    color: #6c757d;
    font-weight: 600;
    line-height: 1.35;
}

.score-wrap {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
}

.score-big {
    text-align: center;
    padding: 14px;
    border-radius: 14px;
    border: 1px solid rgba(0,0,0,0.06);
}

.score-label {
    font-size: 11px;
    font-weight: 900;
    letter-spacing: 0.3px;
    text-transform: uppercase;
    opacity: 0.9;
    margin-bottom: 6px;
}

.score-num {
    font-size: 42px;
    font-weight: 700;
    line-height: 1;
    margin: 0;
}

.score-sub {
    font-size: 12px;
    font-weight: 600;
    opacity: 0.8;
    margin-top: 6px;
}

.pill-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
}

.pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
    background: #f9fafb;
    font-size: 12px;
    font-weight: 600;
    color: #374151;
    white-space: nowrap;
}

.pill b {
    font-weight: 700;
}

.pill.low { border-color: #86efac; background: #f0fdf4; color: #166534; }
.pill.mid { border-color: #fde047; background: #fefce8; color: #854d0e; }
.pill.high { border-color: #fca5a5; background: #fef2f2; color: #991b1b; }

.note {
    margin-top: 10px;
    font-size: 12px;
    color: #6c757d;
    line-height: 1.4;
}

.mono {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-weight: 800;
    font-size: 12px;
}


/* ==========================================================
   CADASTROS.CSS - Estilos dos Popups de Cadastro
   Menu Geral APESP - Arquitetura Modular
   ========================================================== */

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   POPUP OVERLAY (compartilhado)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.popup-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 3000;
    padding: 16px;
}

.popup-overlay.show {
    display: flex;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   POPUP CONTAINER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.popup-cadastro {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    width: 100%;
    max-width: 580px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    animation: popupEntrada 0.2s ease-out;
}

@keyframes popupEntrada {
    from {
        opacity: 0;
        transform: scale(0.95) translateY(-10px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   POPUP HEADER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.popup-cadastro-header {
    padding: 18px 24px;
    background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
    color: #fff;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.popup-cadastro-header.verde {
    background: linear-gradient(135deg, #15803d 0%, #22c55e 100%);
}

.popup-cadastro-header h2 {
    font-size: 16px;
    font-weight: 700;
    margin: 0;
    letter-spacing: 0.5px;
}

.popup-cadastro-close {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: #fff;
    font-size: 20px;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
}

.popup-cadastro-close:hover {
    background: rgba(255, 255, 255, 0.3);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   POPUP BODY
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.popup-cadastro-body {
    padding: 24px;
    overflow-y: auto;
    flex: 1;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CAMPOS DO FORMULÃRIO
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.campo-popup {
    margin-bottom: 18px;
}

.campo-popup label {
    display: block;
    font-size: 11px;
    font-weight: 700;
    color: #374151;
    text-transform: uppercase;
    margin-bottom: 6px;
    letter-spacing: 0.3px;
}

.campo-popup label.obrigatorio::after {
    content: ' *';
    color: #dc2626;
}

.campo-popup input,
.campo-popup select {
    width: 100%;
    padding: 12px 14px;
    font-size: 14px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    background: #fff;
    transition: border-color 0.2s, box-shadow 0.2s;
    box-sizing: border-box;
}

.campo-popup input:focus,
.campo-popup select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
}

.campo-popup input::placeholder {
    color: #9ca3af;
}

/* Linha com mÃºltiplos campos */
.campo-row-popup {
    display: flex;
    gap: 16px;
}

.campo-row-popup .campo-popup {
    flex: 1;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOOKUP (Autocomplete)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.lookup-popup-wrap {
    position: relative;
}

.lookup-popup-list {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #fff;
    border: 2px solid #3b82f6;
    border-top: none;
    border-radius: 0 0 8px 8px;
    max-height: 220px;
    overflow-y: auto;
    z-index: 100;
    display: none;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
}

.lookup-popup-list.show {
    display: block;
}

.lookup-popup-item {
    padding: 12px 14px;
    cursor: pointer;
    display: flex;
    gap: 12px;
    border-bottom: 1px solid #f3f4f6;
    font-size: 13px;
    transition: background 0.15s;
}

.lookup-popup-item:last-child {
    border-bottom: none;
}

.lookup-popup-item:hover {
    background: #eff6ff;
}

.lookup-popup-item.active {
    background: #dbeafe;
    outline: none;
}

.lookup-popup-item-cod {
    font-family: 'Consolas', 'Monaco', monospace;
    font-weight: 700;
    color: #1e40af;
    min-width: 60px;
}

.lookup-popup-item-desc {
    color: #1f2937;
    flex: 1;
}

.lookup-popup-loading,
.lookup-popup-empty {
    padding: 14px;
    color: #6b7280;
    font-size: 13px;
    text-align: center;
    font-style: italic;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   POPUP FOOTER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.popup-cadastro-footer {
    padding: 16px 24px;
    background: #f9fafb;
    border-top: 1px solid #e5e7eb;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTÃ•ES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn-popup-cancelar {
    background: #e5e7eb;
    color: #374151;
    border: none;
    padding: 12px 24px;
    font-size: 13px;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s;
}

.btn-popup-cancelar:hover {
    background: #d1d5db;
}

.btn-popup-salvar {
    background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
    color: #fff;
    border: none;
    padding: 12px 28px;
    font-size: 13px;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    transition: transform 0.15s, box-shadow 0.15s;
}

.btn-popup-salvar:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
}

.btn-popup-salvar:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.btn-popup-salvar.verde {
    background: linear-gradient(135deg, #15803d 0%, #22c55e 100%);
}

.btn-popup-salvar.verde:hover {
    box-shadow: 0 4px 12px rgba(21, 128, 61, 0.3);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   POPUP SUCESSO
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.popup-sucesso {
    max-width: 420px;
    text-align: center;
}

.popup-sucesso .popup-cadastro-header {
    background: linear-gradient(135deg, #15803d 0%, #22c55e 100%);
}

.popup-sucesso-icon {
    font-size: 48px;
    margin: 20px 0 10px;
}

.popup-sucesso-code {
    background: #1f2937;
    color: #4ade80;
    padding: 18px;
    margin: 16px 24px;
    border-radius: 8px;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 13px;
    text-align: left;
    white-space: pre;
    line-height: 1.6;
}

.btn-popup-copiar {
    background: #3b82f6;
    color: #fff;
    border: none;
    padding: 10px 20px;
    font-size: 12px;
    font-weight: 600;
    border-radius: 6px;
    cursor: pointer;
    margin-bottom: 20px;
    transition: background 0.2s;
}

.btn-popup-copiar:hover {
    background: #2563eb;
}

.btn-popup-copiar.copiado {
    background: #22c55e;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVO
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 600px) {
    .popup-cadastro {
        max-height: 95vh;
        border-radius: 12px 12px 0 0;
        margin-top: auto;
    }
    
    .popup-overlay {
        align-items: flex-end;
        padding: 0;
    }
    
    .campo-row-popup {
        flex-direction: column;
        gap: 0;
    }
    
    .popup-cadastro-body {
        padding: 20px 16px;
    }
    
    .popup-cadastro-footer {
        padding: 16px;
    }
}

    </style>
</head>
<body>
    <div class="container">
        <div class="watermark"></div>

        <div class="header">
            <div class="header-left">
                <img src="https://i.ibb.co/7tDmPNcX/2.png" alt="Logo APESP" class="header-logo">
                <div class="header-titulo">
                    Auto PeÃ§as SÃ£o Paulo
                    <span class="header-emoji">ğŸ†</span>
                </div>
            </div>
            <div class="header-right">
                Menu Geral Sankhya
            </div>
        </div>

        <div class="versiculo-bar">
            <div class="versiculo-content">
                <span class="versiculo-icone">âœï¸</span>
                <span id="versiculoDia" class="versiculo-texto">Carregando versÃ­culo...</span>
                <button class="versiculo-btn" onclick="carregarVersiculo()" title="Novo versÃ­culo">ğŸ”„</button>
            </div>
        </div>

        <div class="content">
            <div class="grid">
                <!-- Linha 1 -->
                <a href="javascript:abrirPopupNovoParceiro();" class="menu-item active">
                    <div class="icon-wrapper">
                        <img src="https://i.ibb.co/F4pdsLCS/7.png" alt="Cadastrar Parceiro" style="width: 56px; height: 56px; object-fit: contain;">
                    </div>
                    <span>Cadastrar Novo<br>Parceiro</span>
                </a>

                <a href="javascript:abrirPopupNovoProduto();" class="menu-item active">
                    <div class="icon-wrapper">
                        <img src="https://i.ibb.co/PZH4XvBx/buscaprod.png" alt="Cadastrar Produto" style="width: 56px; height: 56px; object-fit: contain;">
                    </div>
                    <span>Cadastrar Novo<br>Produto</span>
                </a>

                <a href="javascript:abrirTelaInterna('br.com.sankhya.menu.adicional.nuDsb.330.1');" class="menu-item active">
                    <div class="icon-wrapper">
                        <img src="https://i.ibb.co/whWfFjSy/link-c-produtos.png" alt="#207 - Conferir Vinculo de Produtos por Nunota XML" style="width: 56px; height: 56px; object-fit: contain;">
                    </div>
                    <span>#207- Conferir Vinculo de Produtos<br>por Nunota XML</span>
                </a>

                <a href="#" class="menu-item em-construcao" onclick="return false;">
                    <div class="icon-wrapper">
                        <svg viewBox="0 0 24 24" fill="#bdc3c7">
                            <rect x="2" y="2" width="20" height="4" rx="1" fill="#999"/>
                            <path d="M1 21h22L12 8 1 21z"/>
                            <rect x="10" y="14" width="4" height="2" fill="#999"/>
                        </svg>
                    </div>
                    <span>Em ConstruÃ§Ã£o</span>
                </a>

                <!-- Linha 2 -->
                <a href="#" class="menu-item em-construcao" onclick="return false;">
                    <div class="icon-wrapper">
                        <svg viewBox="0 0 24 24" fill="#bdc3c7">
                            <rect x="2" y="2" width="20" height="4" rx="1" fill="#999"/>
                            <path d="M1 21h22L12 8 1 21z"/>
                            <rect x="10" y="14" width="4" height="2" fill="#999"/>
                        </svg>
                    </div>
                    <span>Em ConstruÃ§Ã£o</span>
                </a>

                <a href="#" class="menu-item em-construcao" onclick="return false;">
                    <div class="icon-wrapper">
                        <svg viewBox="0 0 24 24" fill="#bdc3c7">
                            <rect x="2" y="2" width="20" height="4" rx="1" fill="#999"/>
                            <path d="M1 21h22L12 8 1 21z"/>
                            <rect x="10" y="14" width="4" height="2" fill="#999"/>
                        </svg>
                    </div>
                    <span>Em ConstruÃ§Ã£o</span>
                </a>

                <a href="#" class="menu-item em-construcao" onclick="return false;">
                    <div class="icon-wrapper">
                        <svg viewBox="0 0 24 24" fill="#bdc3c7">
                            <rect x="2" y="2" width="20" height="4" rx="1" fill="#999"/>
                            <path d="M1 21h22L12 8 1 21z"/>
                            <rect x="10" y="14" width="4" height="2" fill="#999"/>
                        </svg>
                    </div>
                    <span>Em ConstruÃ§Ã£o</span>
                </a>

                <a href="#" class="menu-item em-construcao" onclick="return false;">
                    <div class="icon-wrapper">
                        <svg viewBox="0 0 24 24" fill="#bdc3c7">
                            <rect x="2" y="2" width="20" height="4" rx="1" fill="#999"/>
                            <path d="M1 21h22L12 8 1 21z"/>
                            <rect x="10" y="14" width="4" height="2" fill="#999"/>
                        </svg>
                    </div>
                    <span>Em ConstruÃ§Ã£o</span>
                </a>

                <!-- Linha 3 - Itens Ativos -->
                <a href="javascript:abrirModalCpf();" class="menu-item active">
                    <div class="icon-wrapper">
                        <img src="https://i.ibb.co/GvHRRjWd/Design-sem-nome.png" alt="Consultar CPF" style="width: 56px; height: 56px; object-fit: contain;">
                    </div>
                    <span>Consultar CPF</span>
                </a>

                <a href="javascript:abrirTelaInterna(RESOURCE_ID_DASH_ALVO);" class="menu-item active">
                    <div class="icon-wrapper">
                        <img src="https://i.ibb.co/XZskFTh6/Design-sem-nome-1.png" alt="Dashboard" style="width: 56px; height: 56px; object-fit: contain;">
                    </div>
                    <span>CotaÃ§Ã£o RÃ¡pida<br>Compras</span>
                </a>

                <a href="javascript:abrirTelaInterna('br.com.sankhya.menu.adicional.nuDsb.327.1');" class="menu-item active">
                    <div class="icon-wrapper">
                        <img src="https://i.ibb.co/nqnvghRV/buscaprod.png" alt="Busca Produto" style="width: 56px; height: 56px; object-fit: contain;">
                    </div>
                    <span>Busca Produto</span>
                </a>

                <a href="#" class="menu-item em-construcao" onclick="return false;">
                    <div class="icon-wrapper">
                        <svg viewBox="0 0 24 24" fill="#bdc3c7">
                            <rect x="2" y="2" width="20" height="4" rx="1" fill="#999"/>
                            <path d="M1 21h22L12 8 1 21z"/>
                            <rect x="10" y="14" width="4" height="2" fill="#999"/>
                        </svg>
                    </div>
                    <span>Em ConstruÃ§Ã£o</span>
                </a>

                <a href="#" class="menu-item em-construcao" onclick="return false;">
                    <div class="icon-wrapper">
                        <svg viewBox="0 0 24 24" fill="#bdc3c7">
                            <rect x="2" y="2" width="20" height="4" rx="1" fill="#999"/>
                            <path d="M1 21h22L12 8 1 21z"/>
                            <rect x="10" y="14" width="4" height="2" fill="#999"/>
                        </svg>
                    </div>
                    <span>Em ConstruÃ§Ã£o</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Modal CPF -->
    <div id="modalCpfBackdrop" class="modal-backdrop">
        <div class="modal">
            <h3>Consulta por CPF</h3>
            <p>Digite o CPF do cliente para executar a consulta de Score.</p>
            <input id="inputCpfConsulta" placeholder="000.000.000-00" inputmode="numeric" autocomplete="off" />
            <div class="modal-actions">
                <div id="cpfSpinner" class="spinner"></div>
                <button class="btn btn-secondary" type="button" onclick="fecharModalCpf()" id="btnCancelarCpf">Cancelar</button>
                <button class="btn btn-primary" type="button" onclick="confirmarCpf()" id="btnExecutarCpf">Executar</button>
            </div>
        </div>
    </div>

    <!-- Modal Resultado -->
    <div id="modalResultadoBackdrop" class="modal-backdrop">
        <div class="modal">
            <h3>Resultado da Consulta</h3>
            <div id="resultadoContainer"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" type="button" onclick="fecharModalResultado()">Fechar</button>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- POPUP NOVO PARCEIRO -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="popup-overlay" id="popupNovoParceiro">
        <div class="popup-cadastro">
            <div class="popup-cadastro-header">
                <h2>CADASTRAR NOVO PARCEIRO</h2>
                <button class="popup-cadastro-close" onclick="fecharPopupNovoParceiro()">&times;</button>
            </div>
            <div class="popup-cadastro-body">
                <!-- Nome -->
                <div class="campo-popup">
                    <label class="obrigatorio">Nome do Parceiro</label>
                    <input type="text" id="parc_nome" placeholder="Digite o nome completo" maxlength="100" autocomplete="off">
                </div>

                <!-- CPF e Telefone -->
                <div class="campo-row-popup">
                    <div class="campo-popup">
                        <label>CPF (opcional)</label>
                        <input type="text" id="parc_cpf" placeholder="000.000.000-00" maxlength="14" inputmode="numeric" oninput="mascaraCPF(this)" autocomplete="off">
                    </div>
                    <div class="campo-popup">
                        <label class="obrigatorio">Telefone</label>
                        <input type="text" id="parc_telefone" placeholder="(00) 00000-0000" maxlength="15" inputmode="tel" oninput="mascaraTelefone(this)" autocomplete="off">
                    </div>
                </div>

                <!-- CEP -->
                <div class="campo-popup">
                    <label class="obrigatorio">CEP</label>
                    <input type="text" id="parc_cep" placeholder="00000-000" maxlength="9" inputmode="numeric" oninput="mascaraCEP(this)" autocomplete="off">
                </div>

                <!-- Cidade - Lookup -->
                <div class="campo-popup">
                    <label class="obrigatorio">Cidade</label>
                    <div class="lookup-popup-wrap">
                        <input type="hidden" id="parc_codcid">
                        <input type="text" class="lookup-popup-input" id="parc_cidade_input" 
                               placeholder="Digite cÃ³digo ou nome da cidade..." 
                               oninput="buscarCidadePopup(this.value)" 
                               onfocus="mostrarListaCidadePopup()" 
                               onkeydown="navegarListaCidadePopup(event)"
                               autocomplete="off">
                        <div class="lookup-popup-list" id="parc_lista_cidade"></div>
                    </div>
                </div>

                <!-- Logradouro - Lookup -->
                <div class="campo-popup">
                    <label class="obrigatorio">Logradouro</label>
                    <div class="lookup-popup-wrap">
                        <input type="hidden" id="parc_codend">
                        <input type="text" class="lookup-popup-input" id="parc_logradouro_input" 
                               placeholder="Digite cÃ³digo ou nome do logradouro..." 
                               oninput="buscarLogradouroPopup(this.value)" 
                               onfocus="mostrarListaLogradouroPopup()" 
                               onkeydown="navegarListaLogradouroPopup(event)"
                               autocomplete="off">
                        <div class="lookup-popup-list" id="parc_lista_logradouro"></div>
                    </div>
                </div>

                <!-- NÃºmero -->
                <div class="campo-popup">
                    <label class="obrigatorio">NÃºmero</label>
                    <input type="text" id="parc_numero" placeholder="NÃºmero do endereÃ§o" maxlength="20" autocomplete="off">
                </div>
            </div>
            <div class="popup-cadastro-footer">
                <button class="btn-popup-cancelar" onclick="fecharPopupNovoParceiro()">Cancelar</button>
                <button class="btn-popup-salvar" onclick="salvarParceiro()">Salvar Parceiro</button>
            </div>
        </div>
    </div>

    <!-- POPUP SUCESSO PARCEIRO -->
    <div class="popup-overlay" id="popupSucessoParceiro">
        <div class="popup-cadastro popup-sucesso">
            <div class="popup-cadastro-header">
                <h2>âœ“ PARCEIRO INSERIDO!</h2>
                <button class="popup-cadastro-close" onclick="fecharPopupSucessoParceiro()">&times;</button>
            </div>
            <div class="popup-sucesso-icon">ğŸ‰</div>
            <div class="popup-sucesso-code" id="parc_sucesso_code"></div>
            <button class="btn-popup-copiar" onclick="copiarDadosParceiro()">Copiar</button>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- POPUP NOVO PRODUTO -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="popup-overlay" id="popupNovoProduto">
        <div class="popup-cadastro">
            <div class="popup-cadastro-header verde">
                <h2>CADASTRAR NOVO PRODUTO</h2>
                <button class="popup-cadastro-close" onclick="fecharPopupNovoProduto()">&times;</button>
            </div>
            <div class="popup-cadastro-body">
                <!-- Nome do Produto -->
                <div class="campo-popup">
                    <label class="obrigatorio">Nome do Produto</label>
                    <input type="text" id="prod_descrprod" placeholder="Digite o nome do produto" maxlength="200" autocomplete="off">
                </div>

                <!-- Marca - Lookup -->
                <div class="campo-popup">
                    <label class="obrigatorio">Marca</label>
                    <div class="lookup-popup-wrap">
                        <input type="hidden" id="prod_codmarca">
                        <input type="hidden" id="prod_nomemarca">
                        <input type="text" class="lookup-popup-input" id="prod_marca_input" 
                               placeholder="Digite cÃ³digo ou nome da marca..." 
                               oninput="buscarMarcaPopup(this.value)" 
                               onfocus="mostrarListaMarcaPopup()" 
                               onkeydown="navegarListaMarcaPopup(event)"
                               autocomplete="off">
                        <div class="lookup-popup-list" id="prod_lista_marca"></div>
                    </div>
                </div>

                <!-- Grupo - Lookup -->
                <div class="campo-popup">
                    <label class="obrigatorio">Grupo de Produtos</label>
                    <div class="lookup-popup-wrap">
                        <input type="hidden" id="prod_codgrupoprod">
                        <input type="text" class="lookup-popup-input" id="prod_grupo_input" 
                               placeholder="Digite cÃ³digo ou nome do grupo..." 
                               oninput="buscarGrupoPopup(this.value)" 
                               onfocus="mostrarListaGrupoPopup()" 
                               onkeydown="navegarListaGrupoPopup(event)"
                               autocomplete="off">
                        <div class="lookup-popup-list" id="prod_lista_grupo"></div>
                    </div>
                </div>

                <!-- Campos Opcionais -->
                <div class="campo-row-popup">
                    <div class="campo-popup">
                        <label>CÃ³digo Similar</label>
                        <input type="text" id="prod_compldesc" placeholder="CÃ³digo similar (opcional)" maxlength="100" autocomplete="off">
                    </div>
                    <div class="campo-popup">
                        <label>ReferÃªncia Fornecedor</label>
                        <input type="text" id="prod_refforn" placeholder="CÃ³digo do fornecedor" maxlength="50" autocomplete="off">
                    </div>
                </div>
            </div>
            <div class="popup-cadastro-footer">
                <button class="btn-popup-cancelar" onclick="fecharPopupNovoProduto()">Cancelar</button>
                <button class="btn-popup-salvar verde" onclick="salvarProduto()">Salvar Produto</button>
            </div>
        </div>
    </div>

    <!-- POPUP SUCESSO PRODUTO -->
    <div class="popup-overlay" id="popupSucessoProduto">
        <div class="popup-cadastro popup-sucesso">
            <div class="popup-cadastro-header">
                <h2>âœ“ PRODUTO INSERIDO!</h2>
                <button class="popup-cadastro-close" onclick="fecharPopupSucessoProduto()">&times;</button>
            </div>
            <div class="popup-sucesso-icon">ğŸ“¦</div>
            <div class="popup-sucesso-code" id="prod_sucesso_code"></div>
            <button class="btn-popup-copiar" onclick="copiarDadosProduto()">Copiar</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/gh/wansleynery/SankhyaJX@main/jx.min.js"></script>
        <script>
/* ==========================================================
   UTILS - FunÃ§Ãµes auxiliares
   ========================================================== */

function formatarCPF(cpf) {
    if (!cpf || cpf.length !== 11) return cpf || '';
    return cpf.substring(0, 3) + '.' + cpf.substring(3, 6) + '.' + cpf.substring(6, 9) + '-' + cpf.substring(9, 11);
}

function escapeHtml(str) {
    return String(str || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}


/* ==========================================================
   CONFIG - Menu Geral APESP
   ========================================================== */

var ID_BOTAO_ROTINA = 124;
var NOME_PARAMETRO = 'CPF_CONSULTA';
var RESOURCE_ID_DASH_ALVO = 'br.com.sankhya.menu.adicional.nuDsb.325.1';


/* ==========================================================
   MAIN - Menu Geral APESP
   ========================================================== */

var VERSICULOS_FALLBACK = [
    { texto: 'Tudo posso naquele que me fortalece.', ref: 'Filipenses 4:13' },
    { texto: 'O Senhor Ã© meu pastor e nada me faltarÃ¡.', ref: 'Salmos 23:1' },
    { texto: 'Confie no Senhor de todo o seu coraÃ§Ã£o e nÃ£o se apoie em seu prÃ³prio entendimento.', ref: 'ProvÃ©rbios 3:5' },
    { texto: 'Porque Deus amou o mundo de tal maneira que deu o seu Filho unigÃªnito, para que todo aquele que nele crÃª nÃ£o pereÃ§a, mas tenha a vida eterna.', ref: 'JoÃ£o 3:16' },
    { texto: 'Busquem, pois, em primeiro lugar o Reino de Deus e a sua justiÃ§a, e todas essas coisas lhes serÃ£o acrescentadas.', ref: 'Mateus 6:33' },
    { texto: 'Entrega o teu caminho ao Senhor; confia nele, e ele tudo farÃ¡.', ref: 'Salmos 37:5' },
    { texto: 'NÃ£o temas, porque eu sou contigo; nÃ£o te assombres, porque eu sou teu Deus; eu te fortaleÃ§o, e te ajudo.', ref: 'IsaÃ­as 41:10' },
    { texto: 'Em tudo dai graÃ§as, porque esta Ã© a vontade de Deus em Cristo Jesus para convosco.', ref: '1 Tessalonicenses 5:18' },
    { texto: 'Alegrem-se sempre no Senhor. Novamente direi: alegrem-se!', ref: 'Filipenses 4:4' },
    { texto: 'LanÃ§a o teu cuidado sobre o Senhor, e ele te susterÃ¡; nunca permitirÃ¡ que o justo seja abalado.', ref: 'Salmos 55:22' },
    { texto: 'Vinde a mim, todos os que estais cansados e oprimidos, e eu vos aliviarei.', ref: 'Mateus 11:28' },
    { texto: 'E conhecereis a verdade, e a verdade vos libertarÃ¡.', ref: 'JoÃ£o 8:32' },
    { texto: 'Porque eu bem sei os pensamentos que tenho a vosso respeito, diz o Senhor; pensamentos de paz, e nÃ£o de mal.', ref: 'Jeremias 29:11' }
];

function carregarVersiculo() {
    var elemento = document.getElementById('versiculoDia');
    if (!elemento) return;

    elemento.innerHTML = '<em style="opacity:0.7">Carregando...</em>';

    fetch('https://www.abibliadigital.com.br/api/verses/nvi/random')
        .then(function(response) {
            if (!response.ok) throw new Error('API indisponÃ­vel');
            return response.json();
        })
        .then(function(data) {
            var texto = data.text || '';
            var livro = data.book ? data.book.name : '';
            var capitulo = data.chapter || '';
            var versiculo = data.number || '';
            var referencia = livro + ' ' + capitulo + ':' + versiculo;

            elemento.innerHTML = '"' + texto + '"<span class="versiculo-ref">â€” ' + referencia + '</span>';
        })
        .catch(function() {
            console.warn('API bÃ­blica indisponÃ­vel, usando fallback local');
            exibirVersiculoLocal();
        });
}

function exibirVersiculoLocal() {
    var indice = Math.floor(Math.random() * VERSICULOS_FALLBACK.length);
    var v = VERSICULOS_FALLBACK[indice];

    var elemento = document.getElementById('versiculoDia');
    if (elemento) {
        elemento.innerHTML = '"' + v.texto + '"<span class="versiculo-ref">â€” ' + v.ref + '</span>';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    carregarVersiculo();

    if (typeof carregarDadosParceiro === 'function') {
        carregarDadosParceiro();
    }
    if (typeof carregarDadosProduto === 'function') {
        carregarDadosProduto();
    }

    document.addEventListener('click', function(e) {
        if (!e.target.closest('.lookup-popup-wrap')) {
            var listas = document.querySelectorAll('.lookup-popup-list');
            for (var i = 0; i < listas.length; i++) {
                listas[i].classList.remove('show');
            }
        }
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            var overlays = document.querySelectorAll('.popup-overlay.show');
            if (overlays.length > 0) {
                overlays[overlays.length - 1].classList.remove('show');
            }
        }
    });
});

function abrirTelaInterna(resourceId) {
    if (typeof JX !== 'undefined' && typeof JX.abrirPagina === 'function') {
        JX.abrirPagina(resourceId, {});
        return;
    }

    try {
        window.parent.postMessage({
            action: 'openApp',
            resourceId: resourceId
        }, '*');
        return;
    } catch (e) {
        console.error('postMessage falhou:', e);
    }

    try {
        window.top.postMessage({
            action: 'openApp',
            resourceId: resourceId
        }, '*');
        return;
    } catch (e) {
        console.error('top.postMessage falhou:', e);
    }

    alert('NÃ£o foi possÃ­vel abrir a tela internamente. Verifique o resourceId ou entre em contato com o suporte.');
}

function abrirModalCpf() {
    document.getElementById('modalCpfBackdrop').style.display = 'flex';
    setTimeout(function() {
        document.getElementById('inputCpfConsulta').focus();
    }, 0);
}

function fecharModalCpf() {
    if (isExecutando) return;
    document.getElementById('modalCpfBackdrop').style.display = 'none';
    document.getElementById('inputCpfConsulta').value = '';
}

function abrirModalResultado(html) {
    document.getElementById('resultadoContainer').innerHTML = html || "<div style='color:#b00;'>Nenhum conteÃºdo retornado.</div>";
    document.getElementById('modalResultadoBackdrop').style.display = 'flex';
}

function fecharModalResultado() {
    document.getElementById('modalResultadoBackdrop').style.display = 'none';
    document.getElementById('resultadoContainer').innerHTML = '';
}

document.getElementById('modalCpfBackdrop').addEventListener('click', function(e) {
    if (e.target && e.target.id === 'modalCpfBackdrop') fecharModalCpf();
});
document.getElementById('modalResultadoBackdrop').addEventListener('click', function(e) {
    if (e.target && e.target.id === 'modalResultadoBackdrop') fecharModalResultado();
});

var isExecutando = false;

function setLoading(loading) {
    isExecutando = loading;
    document.getElementById('cpfSpinner').style.display = loading ? 'inline-block' : 'none';
    document.getElementById('btnExecutarCpf').disabled = loading;
    document.getElementById('btnCancelarCpf').disabled = loading;
}

function normalizarCpf(v) { return (v || '').replace(/\D/g, ''); }

async function confirmarCpf() {
    var cpf = normalizarCpf(document.getElementById('inputCpfConsulta').value);

    if (!cpf) { alert('Informe o CPF.'); return; }
    if (cpf.length !== 11) { alert('CPF invÃ¡lido. Deve ter 11 dÃ­gitos.'); return; }

    var params = {};
    params[NOME_PARAMETRO] = cpf;

    try {
        setLoading(true);

        var res = await JX.acionarBotao(params, { idBotao: ID_BOTAO_ROTINA, tipo: 'JAVA' });

        var htmlRetorno =
            (res && (res.mensagemRetorno || res.mensagem || res.message)) ||
            (res && res.data && (res.data.mensagemRetorno || res.data.mensagem || res.data.message)) ||
            null;

        fecharModalCpf();

        if (htmlRetorno && typeof htmlRetorno === 'string' && htmlRetorno.indexOf('<') >= 0) {
            abrirModalResultado(htmlRetorno);
            return;
        }

        var htmlNovo = await montarResultadoVisualViaBanco(cpf);
        abrirModalResultado(htmlNovo);

    } catch (err) {
        console.error(err);
        alert((err && err.message) || 'Falha ao executar a rotina.');
    } finally {
        setLoading(false);
    }
}

async function montarResultadoVisualViaBanco(cpf) {
    var SQL = '\
        SELECT\
            DTCONSULTA,\
            NOMEPARC,\
            STATUS,\
            SCORE,\
            SCOREINFO,\
            RISCO,\
            RISCODESC,\
            VAIPAGAR,\
            PROBDESC,\
            COMPORTAMENTO,\
            PAGDESC,\
            PERFIL,\
            PERFILDESC,\
            CODRETORNO\
        FROM AD_CONSULTACPF\
        WHERE CPF = \'' + cpf + '\'\
        ORDER BY DTCONSULTA DESC\
        FETCH FIRST 1 ROWS ONLY\
    ';

    var rows = await JX.consultar(SQL);
    if (!rows || !rows.length) {
        return '\
            <div class="resultado-shell">\
                <div class="resultado-hero">\
                    <div>\
                        <div class="hero-title">ğŸ“Š Consulta Score Positivo</div>\
                        <div class="hero-sub">NÃ£o foi possÃ­vel localizar um registro salvo no histÃ³rico para este CPF.</div>\
                    </div>\
                    <div class="badge-status">âš ï¸ Sem histÃ³rico</div>\
                </div>\
                <div class="resultado-body">\
                    <div class="card">\
                        <h4>ğŸ§¾ IdentificaÃ§Ã£o</h4>\
                        <div class="kv-grid">\
                            <div class="kv">\
                                <div class="k">CPF</div>\
                                <div class="v mono">' + escapeHtml(formatarCPF(cpf)) + '</div>\
                            </div>\
                            <div class="kv">\
                                <div class="k">AÃ§Ã£o sugerida</div>\
                                <div class="v">Verifique a execuÃ§Ã£o da rotina e a gravaÃ§Ã£o em AD_CONSULTACPF.</div>\
                            </div>\
                        </div>\
                    </div>\
                </div>\
            </div>\
        ';
    }

    var r = rows[0];

    var nome = r.NOMEPARC || '---';
    var status = r.STATUS || '---';
    var dtConsulta = r.DTCONSULTA || '';
    var score = Number(r.SCORE || 0);
    var scoreInfo = r.SCOREINFO || '';
    var risco = (r.RISCO || '').toString();
    var riscoDesc = r.RISCODESC || '';
    var prob = Number(r.VAIPAGAR || 0);
    var probDesc = r.PROBDESC || '';
    var comportamento = r.COMPORTAMENTO || '';
    var pagDesc = r.PAGDESC || '';
    var perfil = r.PERFIL || '';
    var perfilDesc = r.PERFILDESC || '';
    var codRetorno = r.CODRETORNO != null ? String(r.CODRETORNO) : '';

    var scoreBg = 'rgba(220,53,69,0.10)', scoreFg = '#721c24';
    var scoreLabel = 'Alto risco';
    if (score >= 700) { scoreBg = 'rgba(40,167,69,0.12)'; scoreFg = '#155724'; scoreLabel = 'Bom score'; }
    else if (score >= 400) { scoreBg = 'rgba(255,193,7,0.14)'; scoreFg = '#856404'; scoreLabel = 'Score mÃ©dio'; }

    var riscoUpper = risco.toUpperCase();
    var riscoClass = 'high';
    if (riscoUpper === 'BAIXO') riscoClass = 'low';
    else if (riscoUpper === 'MEDIO' || riscoUpper === 'MÃ‰DIO') riscoClass = 'mid';

    var statusBadge = status ? 'âœ… ' + escapeHtml(status) : 'âœ… OK';
    var dtTxt = dtConsulta ? String(dtConsulta) : '';

    return '\
        <div class="resultado-shell">\
            <div class="resultado-hero">\
                <div>\
                    <div class="hero-title">ğŸ“Š Consulta Score Positivo</div>\
                    <div class="hero-sub">\
                        Resultado organizado para leitura rÃ¡pida e decisÃ£o.<br>\
                        <span class="mono">CPF ' + escapeHtml(formatarCPF(cpf)) + '</span>\
                        ' + (dtTxt ? ' â€¢ <span>' + escapeHtml(dtTxt) + '</span>' : '') + '\
                    </div>\
                </div>\
                <div class="badge-status">' + statusBadge + '</div>\
            </div>\
            <div class="resultado-body">\
                <div class="sec-grid">\
                    <div class="card">\
                        <h4>ğŸ§¾ IdentificaÃ§Ã£o</h4>\
                        <div class="kv-grid">\
                            <div class="kv">\
                                <div class="k">Cliente</div>\
                                <div class="v">' + escapeHtml(nome) + '</div>\
                            </div>\
                            <div class="kv">\
                                <div class="k">CPF</div>\
                                <div class="v mono">' + escapeHtml(formatarCPF(cpf)) + '</div>\
                            </div>\
                            <div class="kv">\
                                <div class="k">CÃ³digo retorno</div>\
                                <div class="v">' + (codRetorno ? escapeHtml(codRetorno) : '---') + '</div>\
                                <div class="v"><small>Ãštil para suporte/diagnÃ³stico.</small></div>\
                            </div>\
                            <div class="kv">\
                                <div class="k">Status</div>\
                                <div class="v">' + escapeHtml(status) + '</div>\
                                <div class="v"><small>Retornado pela API (ou rotina).</small></div>\
                            </div>\
                        </div>\
                    </div>\
                    <div class="card">\
                        <h4>â­ Score</h4>\
                        <div class="score-wrap">\
                            <div class="score-big" style="background:' + scoreBg + '; color:' + scoreFg + ';">\
                                <div class="score-label">' + escapeHtml(scoreLabel) + '</div>\
                                <div class="score-num">' + (isFinite(score) ? score : 0) + '</div>\
                                <div class="score-sub">de 1000 pontos</div>\
                                ' + (scoreInfo ? '<div class="note">' + escapeHtml(scoreInfo) + '</div>' : '') + '\
                            </div>\
                            <div class="pill-row">\
                                ' + (risco ? '<div class="pill ' + riscoClass + '">ğŸ¯ Risco: <b>' + escapeHtml(risco) + '</b></div>' : '') + '\
                                ' + (prob > 0 ? '<div class="pill low">ğŸ’¯ Prob.: <b>' + prob + '%</b></div>' : '') + '\
                            </div>\
                            ' + ((riscoDesc || probDesc) ? '\
                                <div class="note">\
                                    ' + (riscoDesc ? '<div><b>Risco:</b> ' + escapeHtml(riscoDesc) + '</div>' : '') + '\
                                    ' + (probDesc ? '<div style="margin-top:6px;"><b>Probabilidade:</b> ' + escapeHtml(probDesc) + '</div>' : '') + '\
                                </div>' : '') + '\
                        </div>\
                    </div>\
                </div>\
                <div style="height: 12px;"></div>\
                <div class="card">\
                    <h4>ğŸ“Œ Detalhamento</h4>\
                    <div class="kv-grid">\
                        <div class="kv">\
                            <div class="k">Comportamento de pagamento</div>\
                            <div class="v">' + (comportamento ? escapeHtml(comportamento) : '---') + '</div>\
                            ' + (pagDesc ? '<div class="v"><small>' + escapeHtml(pagDesc) + '</small></div>' : '') + '\
                        </div>\
                        <div class="kv">\
                            <div class="k">Perfil financeiro</div>\
                            <div class="v">' + (perfil ? escapeHtml(perfil) : '---') + '</div>\
                            ' + (perfilDesc ? '<div class="v"><small>' + escapeHtml(perfilDesc) + '</small></div>' : '') + '\
                        </div>\
                    </div>\
                </div>\
                <div class="note">\
                    Dica: use o Score + Risco + Probabilidade como triagem rÃ¡pida; leia o comportamento e perfil para refinar a decisÃ£o.\
                </div>\
            </div>\
        </div>\
    ';
}

document.getElementById('inputCpfConsulta').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') confirmarCpf();
    if (e.key === 'Escape') fecharModalCpf();
});


/* ==========================================================
   PARCEIRO.JS - Cadastro de Novo Parceiro
   Menu Geral APESP - Arquitetura Modular
   ========================================================== */

var CIDADES_POPUP = [];
var LOGRADOUROS_POPUP = [];
var cidadeIndexPopup = -1;
var logradouroIndexPopup = -1;
var ultimoParceiroInserido = {};
var ID_ROTINA_PARCEIRO = 128;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CARREGAR DADOS PARA LOOKUPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function carregarDadosParceiro() {
    JX.consultar("SELECT CODCID, NOMECID, UF FROM TSICID ORDER BY NOMECID")
        .then(function(r) { 
            CIDADES_POPUP = r || []; 
            console.log('[Parceiro] Cidades carregadas:', CIDADES_POPUP.length);
        })
        .catch(function(e) { console.error('[Parceiro] Erro cidades:', e); });

    JX.consultar("SELECT CODEND, NOMEEND, TIPO FROM TSIEND ORDER BY NOMEEND")
        .then(function(r) { 
            LOGRADOUROS_POPUP = r || []; 
            console.log('[Parceiro] Logradouros carregados:', LOGRADOUROS_POPUP.length);
        })
        .catch(function(e) { console.error('[Parceiro] Erro logradouros:', e); });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ABRIR / FECHAR POPUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function abrirPopupNovoParceiro() {
    document.getElementById('popupNovoParceiro').classList.add('show');
    setTimeout(function() { 
        document.getElementById('parc_nome').focus(); 
    }, 100);
}

function fecharPopupNovoParceiro() {
    document.getElementById('popupNovoParceiro').classList.remove('show');
    limparCamposParceiro();
}

function limparCamposParceiro() {
    var campos = ['parc_nome','parc_cpf','parc_telefone','parc_cep','parc_codcid','parc_cidade_input','parc_codend','parc_logradouro_input','parc_numero'];
    for (var i = 0; i < campos.length; i++) {
        var el = document.getElementById(campos[i]);
        if (el) el.value = '';
    }
    var listaCid = document.getElementById('parc_lista_cidade');
    var listaLog = document.getElementById('parc_lista_logradouro');
    if (listaCid) listaCid.classList.remove('show');
    if (listaLog) listaLog.classList.remove('show');
    cidadeIndexPopup = -1;
    logradouroIndexPopup = -1;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOOKUP CIDADE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function mostrarListaCidadePopup() {
    cidadeIndexPopup = -1;
    var lista = document.getElementById('parc_lista_cidade');
    if (!CIDADES_POPUP.length) {
        lista.innerHTML = '<div class="lookup-popup-loading">Carregando cidades...</div>';
        lista.classList.add('show');
        return;
    }
    renderizarListaCidadePopup(CIDADES_POPUP.slice(0, 50));
}

function buscarCidadePopup(termo) {
    cidadeIndexPopup = -1;
    if (!termo) { mostrarListaCidadePopup(); return; }
    var t = termo.toLowerCase();
    var filtrados = CIDADES_POPUP.filter(function(c) {
        return String(c.CODCID).indexOf(termo) >= 0 || 
               c.NOMECID.toLowerCase().indexOf(t) >= 0;
    });
    renderizarListaCidadePopup(filtrados);
}

function renderizarListaCidadePopup(filtrados) {
    var lista = document.getElementById('parc_lista_cidade');
    if (!filtrados.length) {
        lista.innerHTML = '<div class="lookup-popup-empty">Nenhuma cidade encontrada</div>';
    } else {
        var html = '';
        var max = Math.min(filtrados.length, 50);
        for (var i = 0; i < max; i++) {
            var c = filtrados[i];
            var nomeEsc = (c.NOMECID || '').replace(/'/g, "\\'");
            html += '<div class="lookup-popup-item" data-index="' + i + '" ' +
                'onclick="selecionarCidadePopup(' + c.CODCID + ',\'' + nomeEsc + '\',\'' + (c.UF || '') + '\')">' +
                '<span class="lookup-popup-item-cod">' + c.CODCID + '</span>' +
                '<span class="lookup-popup-item-desc">' + c.NOMECID + ' - ' + (c.UF || '') + '</span></div>';
        }
        lista.innerHTML = html;
    }
    lista.classList.add('show');
}

function navegarListaCidadePopup(e) {
    var lista = document.getElementById('parc_lista_cidade');
    var items = lista.querySelectorAll('.lookup-popup-item[data-index]');
    if (!items.length) return;

    if (e.key === 'ArrowDown') {
        e.preventDefault();
        cidadeIndexPopup = Math.min(cidadeIndexPopup + 1, items.length - 1);
        atualizarItemAtivoLookup(items, cidadeIndexPopup);
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        cidadeIndexPopup = Math.max(cidadeIndexPopup - 1, 0);
        atualizarItemAtivoLookup(items, cidadeIndexPopup);
    } else if (e.key === 'Enter' && cidadeIndexPopup >= 0) {
        e.preventDefault();
        items[cidadeIndexPopup].click();
    } else if (e.key === 'Escape') {
        lista.classList.remove('show');
    }
}

function selecionarCidadePopup(cod, nome, uf) {
    document.getElementById('parc_codcid').value = cod;
    document.getElementById('parc_cidade_input').value = cod + ' - ' + nome + ' (' + uf + ')';
    document.getElementById('parc_lista_cidade').classList.remove('show');
    // Foca no prÃ³ximo campo
    document.getElementById('parc_logradouro_input').focus();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOOKUP LOGRADOURO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function mostrarListaLogradouroPopup() {
    logradouroIndexPopup = -1;
    var lista = document.getElementById('parc_lista_logradouro');
    if (!LOGRADOUROS_POPUP.length) {
        lista.innerHTML = '<div class="lookup-popup-loading">Carregando logradouros...</div>';
        lista.classList.add('show');
        return;
    }
    renderizarListaLogradouroPopup(LOGRADOUROS_POPUP.slice(0, 50));
}

function buscarLogradouroPopup(termo) {
    logradouroIndexPopup = -1;
    if (!termo) { mostrarListaLogradouroPopup(); return; }
    var t = termo.toLowerCase();
    var filtrados = LOGRADOUROS_POPUP.filter(function(l) {
        return String(l.CODEND).indexOf(termo) >= 0 || 
               l.NOMEEND.toLowerCase().indexOf(t) >= 0;
    });
    renderizarListaLogradouroPopup(filtrados);
}

function renderizarListaLogradouroPopup(filtrados) {
    var lista = document.getElementById('parc_lista_logradouro');
    if (!filtrados.length) {
        lista.innerHTML = '<div class="lookup-popup-empty">Nenhum logradouro encontrado</div>';
    } else {
        var html = '';
        var max = Math.min(filtrados.length, 50);
        for (var i = 0; i < max; i++) {
            var l = filtrados[i];
            var nomeEsc = (l.NOMEEND || '').replace(/'/g, "\\'");
            html += '<div class="lookup-popup-item" data-index="' + i + '" ' +
                'onclick="selecionarLogradouroPopup(' + l.CODEND + ',\'' + nomeEsc + '\')">' +
                '<span class="lookup-popup-item-cod">' + l.CODEND + '</span>' +
                '<span class="lookup-popup-item-desc">' + (l.TIPO || '') + ' ' + l.NOMEEND + '</span></div>';
        }
        lista.innerHTML = html;
    }
    lista.classList.add('show');
}

function navegarListaLogradouroPopup(e) {
    var lista = document.getElementById('parc_lista_logradouro');
    var items = lista.querySelectorAll('.lookup-popup-item[data-index]');
    if (!items.length) return;

    if (e.key === 'ArrowDown') {
        e.preventDefault();
        logradouroIndexPopup = Math.min(logradouroIndexPopup + 1, items.length - 1);
        atualizarItemAtivoLookup(items, logradouroIndexPopup);
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        logradouroIndexPopup = Math.max(logradouroIndexPopup - 1, 0);
        atualizarItemAtivoLookup(items, logradouroIndexPopup);
    } else if (e.key === 'Enter' && logradouroIndexPopup >= 0) {
        e.preventDefault();
        items[logradouroIndexPopup].click();
    } else if (e.key === 'Escape') {
        lista.classList.remove('show');
    }
}

function selecionarLogradouroPopup(cod, nome) {
    document.getElementById('parc_codend').value = cod;
    document.getElementById('parc_logradouro_input').value = cod + ' - ' + nome;
    document.getElementById('parc_lista_logradouro').classList.remove('show');
    // Foca no prÃ³ximo campo
    document.getElementById('parc_numero').focus();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FUNÃ‡ÃƒO AUXILIAR LOOKUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function atualizarItemAtivoLookup(items, idx) {
    for (var i = 0; i < items.length; i++) {
        items[i].classList.remove('active');
    }
    if (idx >= 0 && items[idx]) {
        items[idx].classList.add('active');
        items[idx].scrollIntoView({ block: 'nearest' });
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MÃSCARAS DE INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function mascaraCPF(input) {
    var v = input.value.replace(/\D/g, '').substring(0, 11);
    if (v.length > 9) {
        v = v.replace(/(\d{3})(\d{3})(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
    } else if (v.length > 6) {
        v = v.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
    } else if (v.length > 3) {
        v = v.replace(/(\d{3})(\d{1,3})/, '$1.$2');
    }
    input.value = v;
}

function mascaraTelefone(input) {
    var v = input.value.replace(/\D/g, '').substring(0, 11);
    if (v.length > 10) {
        v = v.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
    } else if (v.length > 6) {
        v = v.replace(/(\d{2})(\d{4,5})(\d{0,4})/, '($1) $2-$3');
    } else if (v.length > 2) {
        v = v.replace(/(\d{2})(\d{0,5})/, '($1) $2');
    }
    input.value = v;
}

function mascaraCEP(input) {
    var v = input.value.replace(/\D/g, '').substring(0, 8);
    if (v.length > 5) {
        v = v.replace(/(\d{5})(\d{1,3})/, '$1-$2');
    }
    input.value = v;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SALVAR PARCEIRO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function salvarParceiro() {
    var nome = document.getElementById('parc_nome').value.trim();
    var cpf = document.getElementById('parc_cpf').value.replace(/\D/g, '');
    var telefone = document.getElementById('parc_telefone').value.replace(/\D/g, '');
    var cep = document.getElementById('parc_cep').value.replace(/\D/g, '');
    var codcid = document.getElementById('parc_codcid').value;
    var codend = document.getElementById('parc_codend').value;
    var numero = document.getElementById('parc_numero').value.trim();

    // ValidaÃ§Ã£o
    var erros = [];
    if (!nome) erros.push('Nome Ã© obrigatÃ³rio');
    if (!telefone) erros.push('Telefone Ã© obrigatÃ³rio');
    if (!cep) erros.push('CEP Ã© obrigatÃ³rio');
    if (!codcid) erros.push('Cidade Ã© obrigatÃ³ria');
    if (!codend) erros.push('Logradouro Ã© obrigatÃ³rio');
    if (!numero) erros.push('NÃºmero Ã© obrigatÃ³rio');

    if (erros.length) {
        alert('Campos obrigatÃ³rios:\n\n' + erros.join('\n'));
        return;
    }

    // Montar parÃ¢metros para rotina Java
    var params = {
        NOME: nome,
        TELEFONE: telefone,
        CEP: cep,
        CODCID: parseInt(codcid),
        CODEND: parseInt(codend),
        NUMERO: numero
    };

    // CPF opcional
    if (cpf && cpf.length === 11) {
        params.CPF = cpf;
    }

    // Feedback visual
    var btnSalvar = document.querySelector('#popupNovoParceiro .btn-popup-salvar');
    var textoOriginal = btnSalvar.textContent;
    btnSalvar.textContent = 'Salvando...';
    btnSalvar.disabled = true;

    // Chamar rotina Java
    JX.executarAcao(ID_ROTINA_PARCEIRO, params)
        .then(function(resultado) {
            console.log('[Parceiro] Retorno rotina:', resultado);

            var codparc = null;
            if (resultado && resultado.CODPARC) {
                codparc = resultado.CODPARC;
            } else if (resultado && resultado.pk && resultado.pk.CODPARC) {
                codparc = resultado.pk.CODPARC;
            } else if (resultado && resultado.mensagemRetorno) {
                var match = resultado.mensagemRetorno.match(/CODPARC[:\s]*(\d+)/i);
                if (match) codparc = match[1];
            }

            if (!codparc) {
                return JX.consultar("SELECT MAX(CODPARC) AS CODPARC FROM TGFPAR WHERE NOMEPARC = '" + nome.replace(/'/g, "''") + "'")
                    .then(function(r) {
                        return (r && r[0]) ? r[0].CODPARC : 'N/A';
                    });
            }
            return codparc;
        })
        .then(function(codparc) {
            ultimoParceiroInserido = {
                CODPARC: codparc,
                NOME: nome,
                TELEFONE: telefone
            };

            btnSalvar.textContent = textoOriginal;
            btnSalvar.disabled = false;

            fecharPopupNovoParceiro();
            mostrarPopupSucessoParceiro();
        })
        .catch(function(erro) {
            console.error('[Parceiro] Erro ao cadastrar:', erro);
            btnSalvar.textContent = textoOriginal;
            btnSalvar.disabled = false;
            alert('Erro ao cadastrar parceiro:\n\n' + (erro.message || erro));
        });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POPUP SUCESSO PARCEIRO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function mostrarPopupSucessoParceiro() {
    var texto = 'CODPARC:   ' + ultimoParceiroInserido.CODPARC + '\n' +
                'NOME:      ' + ultimoParceiroInserido.NOME + '\n' +
                'TELEFONE:  ' + ultimoParceiroInserido.TELEFONE;
    document.getElementById('parc_sucesso_code').textContent = texto;
    document.getElementById('popupSucessoParceiro').classList.add('show');
}

function fecharPopupSucessoParceiro() {
    document.getElementById('popupSucessoParceiro').classList.remove('show');
}

function copiarDadosParceiro() {
    var texto = 'CODPARC: ' + ultimoParceiroInserido.CODPARC + ' | NOME: ' + ultimoParceiroInserido.NOME + ' | TEL: ' + ultimoParceiroInserido.TELEFONE;
    
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(texto).then(function() {
            mostrarBotaoCopiado('popupSucessoParceiro');
        });
    } else {
        var ta = document.createElement('textarea');
        ta.value = texto;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        mostrarBotaoCopiado('popupSucessoParceiro');
    }
}

function mostrarBotaoCopiado(popupId) {
    var btn = document.querySelector('#' + popupId + ' .btn-popup-copiar');
    if (!btn) return;
    btn.textContent = 'Copiado!';
    btn.classList.add('copiado');
    setTimeout(function() {
        btn.textContent = 'Copiar';
        btn.classList.remove('copiado');
    }, 2000);
}


/* ==========================================================
   PRODUTO.JS - Cadastro de Novo Produto
   Menu Geral APESP - Arquitetura Modular
   Usa JX.salvar() direto na entidade (sem rotina Java)
   ========================================================== */

var MARCAS_POPUP = [];
var GRUPOS_POPUP = [];
var marcaIndexPopup = -1;
var grupoIndexPopup = -1;
var ultimoProdutoInserido = {};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CARREGAR DADOS PARA LOOKUPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function carregarDadosProduto() {
    JX.consultar("SELECT CODIGO, DESCRICAO FROM TGFMAR ORDER BY DESCRICAO")
        .then(function(r) { 
            MARCAS_POPUP = r || []; 
            console.log('[Produto] Marcas carregadas:', MARCAS_POPUP.length);
        })
        .catch(function(e) { console.error('[Produto] Erro marcas:', e); });

    JX.consultar("SELECT CODGRUPOPROD, DESCRGRUPOPROD FROM TGFGRU WHERE ATIVO = 'S' ORDER BY DESCRGRUPOPROD")
        .then(function(r) { 
            GRUPOS_POPUP = r || []; 
            console.log('[Produto] Grupos carregados:', GRUPOS_POPUP.length);
        })
        .catch(function(e) { console.error('[Produto] Erro grupos:', e); });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ABRIR / FECHAR POPUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function abrirPopupNovoProduto() {
    document.getElementById('popupNovoProduto').classList.add('show');
    setTimeout(function() { 
        document.getElementById('prod_descrprod').focus(); 
    }, 100);
}

function fecharPopupNovoProduto() {
    document.getElementById('popupNovoProduto').classList.remove('show');
    limparCamposProduto();
}

function limparCamposProduto() {
    var campos = ['prod_descrprod','prod_codmarca','prod_nomemarca','prod_marca_input','prod_codgrupoprod','prod_grupo_input','prod_compldesc','prod_refforn'];
    for (var i = 0; i < campos.length; i++) {
        var el = document.getElementById(campos[i]);
        if (el) el.value = '';
    }
    var listaMarca = document.getElementById('prod_lista_marca');
    var listaGrupo = document.getElementById('prod_lista_grupo');
    if (listaMarca) listaMarca.classList.remove('show');
    if (listaGrupo) listaGrupo.classList.remove('show');
    marcaIndexPopup = -1;
    grupoIndexPopup = -1;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOOKUP MARCA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function mostrarListaMarcaPopup() {
    marcaIndexPopup = -1;
    var lista = document.getElementById('prod_lista_marca');
    if (!MARCAS_POPUP.length) {
        lista.innerHTML = '<div class="lookup-popup-loading">Carregando marcas...</div>';
        lista.classList.add('show');
        return;
    }
    renderizarListaMarcaPopup(MARCAS_POPUP.slice(0, 50));
}

function buscarMarcaPopup(termo) {
    marcaIndexPopup = -1;
    if (!termo) { mostrarListaMarcaPopup(); return; }
    var t = termo.toLowerCase();
    var filtrados = MARCAS_POPUP.filter(function(m) {
        return String(m.CODIGO).indexOf(termo) >= 0 || 
               m.DESCRICAO.toLowerCase().indexOf(t) >= 0;
    });
    renderizarListaMarcaPopup(filtrados);
}

function renderizarListaMarcaPopup(filtrados) {
    var lista = document.getElementById('prod_lista_marca');
    if (!filtrados.length) {
        lista.innerHTML = '<div class="lookup-popup-empty">Nenhuma marca encontrada</div>';
    } else {
        var html = '';
        var max = Math.min(filtrados.length, 50);
        for (var i = 0; i < max; i++) {
            var m = filtrados[i];
            var descEsc = (m.DESCRICAO || '').replace(/'/g, "\\'");
            html += '<div class="lookup-popup-item" data-index="' + i + '" ' +
                'onclick="selecionarMarcaPopup(' + m.CODIGO + ',\'' + descEsc + '\')">' +
                '<span class="lookup-popup-item-cod">' + m.CODIGO + '</span>' +
                '<span class="lookup-popup-item-desc">' + m.DESCRICAO + '</span></div>';
        }
        lista.innerHTML = html;
    }
    lista.classList.add('show');
}

function navegarListaMarcaPopup(e) {
    var lista = document.getElementById('prod_lista_marca');
    var items = lista.querySelectorAll('.lookup-popup-item[data-index]');
    if (!items.length) return;

    if (e.key === 'ArrowDown') {
        e.preventDefault();
        marcaIndexPopup = Math.min(marcaIndexPopup + 1, items.length - 1);
        atualizarItemAtivoLookupProd(items, marcaIndexPopup);
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        marcaIndexPopup = Math.max(marcaIndexPopup - 1, 0);
        atualizarItemAtivoLookupProd(items, marcaIndexPopup);
    } else if (e.key === 'Enter' && marcaIndexPopup >= 0) {
        e.preventDefault();
        items[marcaIndexPopup].click();
    } else if (e.key === 'Escape') {
        lista.classList.remove('show');
    }
}

function selecionarMarcaPopup(cod, desc) {
    document.getElementById('prod_codmarca').value = cod;
    document.getElementById('prod_nomemarca').value = desc;
    document.getElementById('prod_marca_input').value = cod + ' - ' + desc;
    document.getElementById('prod_lista_marca').classList.remove('show');
    document.getElementById('prod_grupo_input').focus();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOOKUP GRUPO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function mostrarListaGrupoPopup() {
    grupoIndexPopup = -1;
    var lista = document.getElementById('prod_lista_grupo');
    if (!GRUPOS_POPUP.length) {
        lista.innerHTML = '<div class="lookup-popup-loading">Carregando grupos...</div>';
        lista.classList.add('show');
        return;
    }
    renderizarListaGrupoPopup(GRUPOS_POPUP.slice(0, 50));
}

function buscarGrupoPopup(termo) {
    grupoIndexPopup = -1;
    if (!termo) { mostrarListaGrupoPopup(); return; }
    var t = termo.toLowerCase();
    var filtrados = GRUPOS_POPUP.filter(function(g) {
        return String(g.CODGRUPOPROD).indexOf(termo) >= 0 || 
               g.DESCRGRUPOPROD.toLowerCase().indexOf(t) >= 0;
    });
    renderizarListaGrupoPopup(filtrados);
}

function renderizarListaGrupoPopup(filtrados) {
    var lista = document.getElementById('prod_lista_grupo');
    if (!filtrados.length) {
        lista.innerHTML = '<div class="lookup-popup-empty">Nenhum grupo encontrado</div>';
    } else {
        var html = '';
        var max = Math.min(filtrados.length, 50);
        for (var i = 0; i < max; i++) {
            var g = filtrados[i];
            var descEsc = (g.DESCRGRUPOPROD || '').replace(/'/g, "\\'");
            html += '<div class="lookup-popup-item" data-index="' + i + '" ' +
                'onclick="selecionarGrupoPopup(' + g.CODGRUPOPROD + ',\'' + descEsc + '\')">' +
                '<span class="lookup-popup-item-cod">' + g.CODGRUPOPROD + '</span>' +
                '<span class="lookup-popup-item-desc">' + g.DESCRGRUPOPROD + '</span></div>';
        }
        lista.innerHTML = html;
    }
    lista.classList.add('show');
}

function navegarListaGrupoPopup(e) {
    var lista = document.getElementById('prod_lista_grupo');
    var items = lista.querySelectorAll('.lookup-popup-item[data-index]');
    if (!items.length) return;

    if (e.key === 'ArrowDown') {
        e.preventDefault();
        grupoIndexPopup = Math.min(grupoIndexPopup + 1, items.length - 1);
        atualizarItemAtivoLookupProd(items, grupoIndexPopup);
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        grupoIndexPopup = Math.max(grupoIndexPopup - 1, 0);
        atualizarItemAtivoLookupProd(items, grupoIndexPopup);
    } else if (e.key === 'Enter' && grupoIndexPopup >= 0) {
        e.preventDefault();
        items[grupoIndexPopup].click();
    } else if (e.key === 'Escape') {
        lista.classList.remove('show');
    }
}

function selecionarGrupoPopup(cod, desc) {
    document.getElementById('prod_codgrupoprod').value = cod;
    document.getElementById('prod_grupo_input').value = cod + ' - ' + desc;
    document.getElementById('prod_lista_grupo').classList.remove('show');
    document.getElementById('prod_compldesc').focus();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FUNÃ‡ÃƒO AUXILIAR LOOKUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function atualizarItemAtivoLookupProd(items, idx) {
    for (var i = 0; i < items.length; i++) {
        items[i].classList.remove('active');
    }
    if (idx >= 0 && items[idx]) {
        items[idx].classList.add('active');
        items[idx].scrollIntoView({ block: 'nearest' });
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SALVAR PRODUTO (JX.salvar direto na entidade)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function salvarProduto() {
    var descrprod = document.getElementById('prod_descrprod').value.trim();
    var nomemarca = document.getElementById('prod_nomemarca').value.trim();
    var codgrupoprod = document.getElementById('prod_codgrupoprod').value;
    var compldesc = document.getElementById('prod_compldesc').value.trim();
    var refforn = document.getElementById('prod_refforn').value.trim();

    // ValidaÃ§Ã£o
    var erros = [];
    if (!descrprod) erros.push('Nome do Produto Ã© obrigatÃ³rio');
    if (!nomemarca) erros.push('Marca Ã© obrigatÃ³ria');
    if (!codgrupoprod) erros.push('Grupo de Produtos Ã© obrigatÃ³rio');

    if (erros.length) {
        alert('Campos obrigatÃ³rios:\n\n' + erros.join('\n'));
        return;
    }

    // Data atual formatada DD/MM/YYYY HH:MM:SS
    var agora = new Date();
    var dtalter = ('0' + agora.getDate()).slice(-2) + '/' +
                  ('0' + (agora.getMonth() + 1)).slice(-2) + '/' +
                  agora.getFullYear() + ' ' +
                  ('0' + agora.getHours()).slice(-2) + ':' +
                  ('0' + agora.getMinutes()).slice(-2) + ':' +
                  ('0' + agora.getSeconds()).slice(-2);

    // Montar objeto de dados para JX.salvar
    var dados = {
        DESCRPROD: descrprod,
        MARCA: nomemarca,
        CODGRUPOPROD: parseInt(codgrupoprod),
        // Valores fixos (confirmados pelo usuÃ¡rio)
        CODVOL: 'UN',
        CODVOLCOMPRA: 'UN',
        CSTIPIENT: 49,
        CSTIPISAI: 99,
        DTALTER: dtalter,
        GRUPOICMS: 60,
        USALOCAL: 'S',
        USOPROD: 'R',
        TIPSUBST: 'A',
        DESCMAX: 99,
        DECQTD: 2,
        CODIPI: 5,
        CLASSUBTRIB: 14,
        CODFORMPREC: 3,
        NCM: '84879000',
        CODLOCALPADRAO: 101,
        CALCDIFAL: 'S'
    };

    // Campos opcionais
    if (compldesc) dados.COMPLDESC = compldesc;
    if (refforn) dados.REFFORN = refforn;

    // Feedback visual
    var btnSalvar = document.querySelector('#popupNovoProduto .btn-popup-salvar');
    var textoOriginal = btnSalvar.textContent;
    btnSalvar.textContent = 'Salvando...';
    btnSalvar.disabled = true;

    // Chamar JX.salvar na entidade Produto
    JX.salvar(dados, 'Produto', [{}])
        .then(function(resultado) {
            console.log('[Produto] Retorno JX.salvar:', resultado);

            var codprod = null;
            
            // Tentar extrair CODPROD do retorno
            if (resultado && resultado[0] && resultado[0].responseBody && 
                resultado[0].responseBody.entities && resultado[0].responseBody.entities.entity) {
                var entity = resultado[0].responseBody.entities.entity;
                codprod = entity.CODPROD && entity.CODPROD.$;
            }
            if (!codprod && resultado && resultado.pk) {
                codprod = resultado.pk.CODPROD;
            }
            if (!codprod && resultado && resultado.CODPROD) {
                codprod = resultado.CODPROD;
            }
            if (!codprod && resultado && resultado[0] && resultado[0].CODPROD) {
                codprod = resultado[0].CODPROD;
            }

            // Fallback: buscar no banco
            if (!codprod) {
                return JX.consultar("SELECT MAX(CODPROD) AS CODPROD FROM TGFPRO WHERE DESCRPROD = '" + descrprod.replace(/'/g, "''") + "'")
                    .then(function(r) {
                        return (r && r[0]) ? r[0].CODPROD : 'N/A';
                    });
            }
            return codprod;
        })
        .then(function(codprod) {
            ultimoProdutoInserido = {
                CODPROD: codprod,
                NOME: descrprod,
                REFFORN: refforn || '-'
            };

            btnSalvar.textContent = textoOriginal;
            btnSalvar.disabled = false;

            fecharPopupNovoProduto();
            mostrarPopupSucessoProduto();
        })
        .catch(function(erro) {
            console.error('[Produto] Erro ao cadastrar:', erro);
            btnSalvar.textContent = textoOriginal;
            btnSalvar.disabled = false;
            alert('Erro ao cadastrar produto:\n\n' + (erro.message || erro));
        });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POPUP SUCESSO PRODUTO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function mostrarPopupSucessoProduto() {
    var texto = 'CODPROD:  ' + ultimoProdutoInserido.CODPROD + '\n' +
                'NOME:     ' + ultimoProdutoInserido.NOME + '\n' +
                'REFFORN:  ' + ultimoProdutoInserido.REFFORN;
    document.getElementById('prod_sucesso_code').textContent = texto;
    document.getElementById('popupSucessoProduto').classList.add('show');
}

function fecharPopupSucessoProduto() {
    document.getElementById('popupSucessoProduto').classList.remove('show');
}

function copiarDadosProduto() {
    var texto = 'CODPROD: ' + ultimoProdutoInserido.CODPROD + ' | NOME: ' + ultimoProdutoInserido.NOME + ' | REFFORN: ' + ultimoProdutoInserido.REFFORN;
    
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(texto).then(function() {
            mostrarBotaoCopiadoProd('popupSucessoProduto');
        });
    } else {
        var ta = document.createElement('textarea');
        ta.value = texto;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        mostrarBotaoCopiadoProd('popupSucessoProduto');
    }
}

function mostrarBotaoCopiadoProd(popupId) {
    var btn = document.querySelector('#' + popupId + ' .btn-popup-copiar');
    if (!btn) return;
    btn.textContent = 'Copiado!';
    btn.classList.add('copiado');
    setTimeout(function() {
        btn.textContent = 'Copiar';
        btn.classList.remove('copiado');
    }, 2000);
}

    </script>
</body>
</html>
